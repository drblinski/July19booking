<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment | Plump</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      transition: all 0.3s ease;
    }
    
    body.member-theme {
      background: #0a0a0a;
    }
    
    .booking-widget {
      width: 100%;
      max-width: 800px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 85vh;
      min-height: 650px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    body.member-theme .booking-widget {
      background: #1a1a1a;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.15);
      border: 1px solid #333;
    }
    
    /* Member Info Banner */
    .member-info-banner {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      padding: 12px 24px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
      display: none;
    }
    
    body.member-theme .member-info-banner {
      display: block;
    }
    
    .member-info-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .member-badge {
      background: rgba(0, 0, 0, 0.1);
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 700;
    }
    
    .chat-header {
      background: #ffffff;
      padding: 24px 32px;
      border-bottom: 1px solid #f0f1f3;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    body.member-theme .chat-header {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
    }
    
    .chat-title {
      color: #1a1d1f;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
      transition: all 0.3s ease;
    }
    
    body.member-theme .chat-title {
      color: #FFD700;
    }
    
    .chat-subtitle {
      color: #6b7280;
      font-size: 1rem;
      font-weight: 400;
      transition: all 0.3s ease;
    }
    
    body.member-theme .chat-subtitle {
      color: #999;
    }
    
    .messages-container {
      flex: 1;
      padding: 24px 32px;
      overflow-y: auto;
      scroll-behavior: smooth;
      background: #fff;
      transition: all 0.3s ease;
    }
    
    body.member-theme .messages-container {
      background: #1a1a1a;
    }
    
    .message {
      margin-bottom: 24px;
      display: flex;
      animation: slideIn 0.4s ease-out;
      max-width: 100%;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.system {
      justify-content: flex-start;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message-bubble {
      max-width: 75%;
      padding: 16px 20px;
      border-radius: 24px;
      font-size: 1rem;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }
    
    .message.system .message-bubble {
      background: #f8f9fa;
      color: #1a1d1f;
      border-bottom-left-radius: 8px;
    }
    
    body.member-theme .message.system .message-bubble {
      background: #2a2a2a;
      color: #fff;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.1);
    }
    
    .message.user .message-bubble {
      background: linear-gradient(135deg, #FFB89A 0%, #FFA07A 100%);
      color: #fff;
      border-bottom-right-radius: 8px;
    }
    
    body.member-theme .message.user .message-bubble {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: #f8f9fa;
      border-radius: 24px;
      border-bottom-left-radius: 8px;
      max-width: 90px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    body.member-theme .typing-indicator {
      background: #2a2a2a;
    }
    
    .typing-dots {
      display: flex;
      gap: 6px;
    }
    
    .dot {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    body.member-theme .dot {
      background: #FFD700;
    }
    
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-8px); opacity: 1; }
    }
    
    /* Client Type Selection */
    .client-type-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .client-type-button {
      background: #fff;
      border: 2px solid #f0f1f3;
      color: #1a1d1f;
      padding: 32px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 1rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .client-type-button {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }
    
    .client-type-button:hover {
      border-color: #FFB89A;
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(255, 184, 154, 0.15);
    }
    
    body.member-theme .client-type-button:hover {
      border-color: #FFD700;
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.15);
    }
    
    .client-type-button.member-option {
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      color: #FFD700;
      border-color: #FFD700;
    }
    
    .client-type-button.member-option:hover {
      background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
      transform: translateY(-6px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.25);
    }
    
    .client-type-title {
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 1.3rem;
      letter-spacing: -0.02em;
    }
    
    .client-type-desc {
      font-size: 1rem;
      color: #6b7280;
      line-height: 1.4;
    }
    
    body.member-theme .client-type-desc {
      color: #999;
    }
    
    .client-type-button.member-option .client-type-desc {
      color: #FFD700;
      opacity: 0.8;
    }
    
    /* Injector Display */
    .injector-container {
      margin-top: 20px;
    }
    
    .injector-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .injector-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .injector-list::-webkit-scrollbar-track {
      background: #f1f3f4;
      border-radius: 3px;
    }
    
    body.member-theme .injector-list::-webkit-scrollbar-track {
      background: #333;
    }
    
    .injector-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    
    body.member-theme .injector-list::-webkit-scrollbar-thumb {
      background: #FFD700;
    }
    
    .injector-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    
    body.member-theme .injector-list::-webkit-scrollbar-thumb:hover {
      background: #FFA500;
    }
    
    .injector-item {
      background: #fff;
      border: 2px solid #f0f1f3;
      border-radius: 32px;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 16px;
      min-height: 60px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .injector-item {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }
    
    .injector-item:hover {
      border-color: #FFB89A;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 184, 154, 0.12);
    }
    
    body.member-theme .injector-item:hover {
      border-color: #FFD700;
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.12);
    }
    
    .injector-item.first-available {
      background: linear-gradient(135deg, #FFB89A 0%, #FFA07A 100%);
      color: #fff;
      border-color: #FFB89A;
    }
    
    body.member-theme .injector-item.first-available {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      border-color: #FFD700;
    }
    
    .injector-item.first-available:hover {
      background: linear-gradient(135deg, #FF9A7A 0%, #FF8A6A 100%);
      border-color: #FF9A7A;
    }
    
    body.member-theme .injector-item.first-available:hover {
      background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
      border-color: #FFA500;
    }
    
    .injector-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f0f1f3;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }
    
    body.member-theme .injector-photo {
      background: #444;
    }
    
    .injector-name {
      font-weight: 600;
      font-size: 1rem;
      flex: 1;
      text-align: left;
    }
    
    .injector-item.first-available .injector-name {
      color: #fff;
    }
    
    body.member-theme .injector-item.first-available .injector-name {
      color: #000;
    }
    
    /* Location Legend and Staff Schedule Styles */
    .location-legend {
      background: #fafbfc;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #f0f1f3;
    }
    
    body.member-theme .location-legend {
      background: #2a2a2a;
      border-color: #444;
    }
    
    .legend-title {
      font-weight: 700;
      margin-bottom: 16px;
      color: #1a1d1f;
      font-size: 1rem;
      letter-spacing: -0.02em;
    }
    
    body.member-theme .legend-title {
      color: #FFD700;
    }
    
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: #fff;
      border-radius: 20px;
      border: 2px solid #f0f1f3;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .legend-item {
      background: #333;
      border-color: #555;
      color: #fff;
    }
    
    .legend-item:hover {
      border-color: #FFB89A;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(255, 184, 154, 0.12);
    }
    
    body.member-theme .legend-item:hover {
      border-color: #FFD700;
      box-shadow: 0 2px 6px rgba(255, 215, 0, 0.12);
    }
    
    .legend-item.inactive {
      opacity: 0.5;
      background: #f8f9fa;
    }
    
    body.member-theme .legend-item.inactive {
      background: #1a1a1a;
    }
    
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    
    .injector-calendar-day {
      position: relative;
    }
    
    .calendar-slots {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-top: 6px;
    }
    
    .slot-indicator {
      height: 4px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .slot-indicator:hover {
      height: 6px;
      transform: translateY(-1px);
    }
    
    .injector-time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 16px;
      background: #fafbfc;
      border-radius: 16px;
      border: 1px solid #f0f1f3;
      margin-top: 20px;
    }
    
    body.member-theme .injector-time-slots {
      background: #2a2a2a;
      border-color: #444;
    }
    
    .injector-time-slot {
      background: #fff;
      border: 2px solid #f0f1f3;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .injector-time-slot {
      background: #333;
      border-color: #555;
      color: #fff;
    }
    
    .injector-time-slot:hover {
      border-color: #FFB89A;
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(255, 184, 154, 0.12);
    }
    
    body.member-theme .injector-time-slot:hover {
      border-color: #FFD700;
      box-shadow: 0 3px 10px rgba(255, 215, 0, 0.12);
    }
    
    .slot-time {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }
    
    .slot-location {
      font-size: 0.8rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
    }
    
    body.member-theme .slot-location {
      color: #999;
    }
    
    .slot-location-color {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    /* Calendar-style Time Selection */
    .availability-container {
      margin-top: 20px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 8px;
    }
    
    .calendar-nav {
      background: #f8f9fa;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      color: #374151;
    }
    
    body.member-theme .calendar-nav {
      background: #2a2a2a;
      color: #FFD700;
      border: 1px solid #444;
    }
    
    .calendar-nav:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    
    body.member-theme .calendar-nav:hover {
      background: #333;
      border-color: #FFD700;
    }
    
    .calendar-nav:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .calendar-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #1a1d1f;
      letter-spacing: -0.02em;
    }
    
    body.member-theme .calendar-title {
      color: #FFD700;
    }
    
    .calendar-container {
      max-height: 450px;
      overflow-y: auto;
      overflow-x: auto;
      border-radius: 16px;
      border: 1px solid #f0f1f3;
      background: #fafbfc;
      padding: 16px;
    }
    
    body.member-theme .calendar-container {
      background: #2a2a2a;
      border-color: #444;
    }
    
    .calendar-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .calendar-container::-webkit-scrollbar-track {
      background: #f1f3f4;
      border-radius: 4px;
    }
    
    body.member-theme .calendar-container::-webkit-scrollbar-track {
      background: #333;
    }
    
    .calendar-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }
    
    body.member-theme .calendar-container::-webkit-scrollbar-thumb {
      background: #FFD700;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
      min-width: 280px;
    }
    
    .calendar-day-header {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 600;
      padding: 12px 4px;
    }
    
    body.member-theme .calendar-day-header {
      color: #999;
    }
    
    .calendar-day {
      background: #fff;
      border: 2px solid #f0f1f3;
      border-radius: 12px;
      padding: 12px 6px;
      text-align: center;
      font-size: 0.9rem;
      min-height: 70px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .calendar-day {
      background: #333;
      border-color: #555;
      color: #fff;
    }
    
    .calendar-day:hover {
      background: #fef9f6;
      border-color: #FFB89A;
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(255, 184, 154, 0.12);
    }
    
    body.member-theme .calendar-day:hover {
      background: #444;
      border-color: #FFD700;
      box-shadow: 0 3px 10px rgba(255, 215, 0, 0.12);
    }
    
    .calendar-day.has-availability {
      background: #fff;
      border-color: #10b981;
    }
    
    body.member-theme .calendar-day.has-availability {
      background: #333;
      border-color: #10b981;
    }
    
    .calendar-day.has-availability:hover {
      background: #f0fdf4;
      border-color: #059669;
    }
    
    body.member-theme .calendar-day.has-availability:hover {
      background: #0a4a37;
      border-color: #10b981;
    }
    
    .calendar-day.selected {
      background: linear-gradient(135deg, #FFB89A 0%, #FFA07A 100%);
      color: #fff;
      border-color: #FFB89A;
    }
    
    body.member-theme .calendar-day.selected {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      border-color: #FFD700;
    }
    
    .calendar-day.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .calendar-day.disabled:hover {
      background: #fff;
      border-color: #f0f1f3;
      transform: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .calendar-day.disabled:hover {
      background: #333;
      border-color: #555;
    }
    
    .day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .day-availability {
      font-size: 0.7rem;
      color: #10b981;
      font-weight: 600;
    }
    
    .calendar-day.selected .day-availability {
      color: rgba(255, 255, 255, 0.8);
    }
    
    body.member-theme .calendar-day.selected .day-availability {
      color: rgba(0, 0, 0, 0.8);
    }
    
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 16px;
      background: #fafbfc;
      border-radius: 16px;
      border: 1px solid #f0f1f3;
      margin-top: 20px;
    }
    
    body.member-theme .time-slots {
      background: #2a2a2a;
      border-color: #444;
    }
    
    .time-slots::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .time-slots::-webkit-scrollbar-track {
      background: #f1f3f4;
      border-radius: 4px;
    }
    
    body.member-theme .time-slots::-webkit-scrollbar-track {
      background: #333;
    }
    
    .time-slots::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }
    
    body.member-theme .time-slots::-webkit-scrollbar-thumb {
      background: #FFD700;
    }
    
    .time-slot {
      background: #fff;
      border: 2px solid #f0f1f3;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .time-slot {
      background: #333;
      border-color: #555;
      color: #fff;
    }
    
    .time-slot:hover {
      background: #fef9f6;
      border-color: #FFB89A;
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(255, 184, 154, 0.12);
    }
    
    body.member-theme .time-slot:hover {
      background: #444;
      border-color: #FFD700;
      box-shadow: 0 3px 10px rgba(255, 215, 0, 0.12);
    }
    
    /* Form Container */
    .form-container {
      background: #fafbfc;
      border-radius: 20px;
      padding: 32px;
      margin-top: 20px;
      border: 1px solid #f0f1f3;
    }
    
    body.member-theme .form-container {
      background: #2a2a2a;
      border-color: #444;
    }
    
    .form-input {
      width: 100%;
      background: #fff;
      border: 2px solid #f0f1f3;
      border-radius: 12px;
      padding: 16px 20px;
      color: #1a1d1f;
      font-size: 1rem;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    body.member-theme .form-input {
      background: #333;
      border-color: #555;
      color: #fff;
    }
    
    .form-input::placeholder {
      color: #9ca3af;
    }
    
    body.member-theme .form-input::placeholder {
      color: #999;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #FFB89A;
      box-shadow: 0 0 0 3px rgba(255, 184, 154, 0.1);
    }
    
    body.member-theme .form-input:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
    }
    
    .form-input.error {
      border-color: #ef4444;
    }
    
    .error-text {
      color: #ef4444;
      font-size: 0.9rem;
      margin-top: -15px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .form-section-title {
      color: #1a1d1f;
      font-weight: 700;
      margin-bottom: 20px;
      margin-top: 24px;
      font-size: 1.2rem;
      letter-spacing: -0.02em;
    }
    
    body.member-theme .form-section-title {
      color: #FFD700;
    }
    
    .form-section-title:first-child {
      margin-top: 0;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    /* Buttons */
    .primary-button {
      background: linear-gradient(135deg, #FFB89A 0%, #FFA07A 100%);
      color: #fff;
      border: none;
      padding: 18px 32px;
      border-radius: 32px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 24px;
      width: 100%;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 3px 12px rgba(255, 184, 154, 0.2);
    }
    
    body.member-theme .primary-button {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      box-shadow: 0 3px 12px rgba(255, 215, 0, 0.2);
    }
    
    .primary-button:hover {
      background: linear-gradient(135deg, #FF9A7A 0%, #FF8A6A 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 154, 122, 0.25);
    }
    
    body.member-theme .primary-button:hover {
      background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
      box-shadow: 0 6px 20px rgba(255, 165, 0, 0.25);
    }
    
    .primary-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .secondary-button {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      border: none;
      padding: 16px 24px;
      border-radius: 24px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .secondary-button:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
    }
    
    .restart-button {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #fff;
      border: 2px solid #f0f1f3;
      color: #374151;
      padding: 12px 20px;
      border-radius: 24px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      z-index: 1000;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    body.member-theme .restart-button {
      background: #2a2a2a;
      border-color: #444;
      color: #FFD700;
    }
    
    .restart-button:hover {
      border-color: #FFB89A;
      background: #fef9f6;
      transform: translateY(-2px);
    }
    
    body.member-theme .restart-button:hover {
      border-color: #FFD700;
      background: #333;
    }
    
    .error-message {
      background: #fef2f2;
      border: 2px solid #fecaca;
      color: #dc2626;
      padding: 20px 24px;
      border-radius: 16px;
      margin-top: 20px;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .success-message {
      background: #f0fdf4;
      border: 2px solid #bbf7d0;
      color: #166534;
      padding: 20px 24px;
      border-radius: 16px;
      margin-top: 20px;
      font-size: 1rem;
      font-weight: 500;
    }
    
    body.member-theme .success-message {
      background: #0f2f1a;
      border-color: #1f5f32;
      color: #10b981;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 0;
        align-items: stretch;
      }
      
      .booking-widget {
        max-width: 100%;
        border-radius: 0;
        height: 100vh;
      }
      
      .messages-container {
        padding: 20px 24px;
      }
      
      .chat-header {
        padding: 20px 24px;
      }
      
      .client-type-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .message-bubble {
        max-width: 85%;
      }
      
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        min-width: 260px;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 8px 4px;
        font-size: 0.85rem;
      }
      
      .injector-list {
        gap: 12px;
        max-height: 300px;
      }
      
      .injector-item {
        padding: 10px 16px;
        min-height: 56px;
        gap: 12px;
      }
      
      .injector-photo {
        width: 36px;
        height: 36px;
      }
      
      .injector-name {
        font-size: 0.95rem;
      }
      
      .time-slots {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .client-type-button {
        padding: 24px;
      }
      
      .form-container {
        padding: 24px;
      }
      
      .restart-button {
        top: 16px;
        right: 16px;
        padding: 10px 16px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="booking-widget">
    <!-- Member Info Banner (hidden by default) -->
    <div class="member-info-banner" id="member-info-banner">
      <div class="member-info-content" id="member-info-content">
        <!-- Will be populated dynamically -->
      </div>
    </div>
    
    <div class="chat-header">
      <div class="chat-title">You are now Booking with Plump</div>
      <div class="chat-subtitle">Book your appointment</div>
    </div>
    
    <div class="restart-button" onclick="restartChat()">Start Over</div>
    
    <div class="messages-container" id="messages"></div>
  </div>

  <script>
    // Debug logging
    console.log('Widget loading...');
    
    // Boulevard API Configuration - now using proxy route
    const BOULEVARD_CONFIG = {
      businessId: 'f6a06736-1132-4365-b79a-a69c648a746a',
      apiKey: '93ca3f15-6f0e-491d-840b-681a0fef80ed',
      apiUrl: '/api/blvd'  // Changed to use proxy route
    };
    
    const LOCATIONS_DATA = {
      'West Village': { 
        locationId: 'ffaaff3c-d5ba-408e-ba3b-455554b77116'
      },
      'SoHo': { 
        locationId: '89763e68-2454-429c-ae9c-c1b4d91e7b81'
      },
      'Tribeca': { 
        locationId: '43dfb866-a872-4f01-9491-6c6584e3c3e7'
      },
      'Williamsburg': { 
        locationId: '93566b17-c023-4fe1-9a84-462f143bd024'
      },
      'Hoboken': { 
        locationId: 'a885e859-21ef-43c7-8a63-bb242db98de2'
      },
      'Uptown': { 
        locationId: 'b146c47b-6de8-475a-8ebd-8a1d2b36546d'
      },
      'Miami': { 
        locationId: '1cbb848e-138b-4142-bc3d-b9f4ea9a42db'
      }
    };
    
    // Staff mapping for "Book By Staff" services
    const STAFF_SERVICES_MAPPING = {
      'Sivan': 'Book Any Service with Sivan',
      'Hannah': 'Book Any Service with Hannah',
      'Amber': 'Book Any Service with Amber',
      'Sara': 'Book Any Service with Sara',
      'Alyssa Lyons': 'Book Any Service with Alyssa Lyons',
      'Macy': 'Book Any Service with Macy',
      'Kaley': 'Book Any Service with Kaley',
      'Paige': 'Book Any Service with Paige',
      'Samantha': 'Book Any Service with Samantha',
      'Felisha': 'Book Any Service with Felisha',
      'Erica': 'Book Any Service with Erica',
      'Kiki': 'Book Any Service with Kiki',
      'Nick': 'Book Any Service with Nick',
      'Michelle': 'Book Any Service with Michelle',
      'Caitlin': 'Book Any Service with Caitlin',
      'Emily': 'Book Any Service with Emily',
      'Diamond': 'Book Any Service with Diamond',
      'Brittany': 'Book with Master Esthetician Brittany',
      'Julia': 'Book Any Service with Julia',
      'Dr. Blinski': 'Any Treatment with Dr. Blinski'
    };
    
    // Mock membership data
    const mockMembershipData = {
      membershipType: Math.random() > 0.5 ? 'Injectable Club' : 'Skin Club',
      credits: Math.floor(Math.random() * 500) + 100 // $100-$600
    };
    
    // Global state
    let conversationState = 'start';
    let clientType = null;
    let treatmentType = null;
    let isMemberTheme = false;
    let selectedInjector = null;
    let selectedInjectorId = null;
    let selectedLocation = null;
    let selectedLocationId = null;
    let selectedService = null;
    let selectedServiceId = null;
    let selectedTime = null;
    let cartId = null;
    let availableStaff = [];
    let availableServices = [];
    let clientInfo = {};
    let currentCalendarDate = new Date();
    let calendarAvailability = {};
    let selectedDate = null;
    
    // Staff Schedule / Injector Availability variables
    let injectorLocations = [];
    let locationColors = {};
    let visibleLocations = new Set();
    let injectorAvailabilityData = {};
    
    console.log('State initialized');
    
    // Reset function to clear all selections and calendar state
    function resetBookingState() {
      // Clear all selection state except client type and theme
      selectedInjector = null;
      selectedInjectorId = null;
      selectedLocation = null;
      selectedLocationId = null;
      selectedService = null;
      selectedServiceId = null;
      selectedTime = null;
      selectedDate = null;
      
      // Clear availability data
      calendarAvailability = {};
      injectorAvailabilityData = {};
      
      // Reset calendar to current month
      currentCalendarDate = new Date();
      
      // Clear cart
      cartId = null;
      
      // Clear staff schedule variables
      injectorLocations = [];
      locationColors = {};
      visibleLocations = new Set();
      
      console.log('üîÑ Booking state reset');
    }
    
    // Utility functions
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    function validatePhoneNumber(phone) {
      const digitsOnly = phone.replace(/\D/g, '');
      return digitsOnly.length >= 10 && digitsOnly.length <= 15;
    }
    
    // Boulevard API helper - Updated to use proxy route
    function makeBoulevardRequest(query, variables = {}) {
      console.log('üî• Making Boulevard request:', { query: query.substring(0, 100) + '...', variables });
      
      return fetch(BOULEVARD_CONFIG.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          query: query,
          variables: variables
        })
      })
      .then(response => {
        console.log('üî• Boulevard response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('üî• Boulevard response data:', data);
        if (data.errors && data.errors.length > 0) {
          console.error('üî• Boulevard GraphQL errors:', data.errors);
          throw new Error(`GraphQL Error: ${data.errors[0].message}`);
        }
        return data.data;
      })
      .catch(error => {
        console.error('üî• Boulevard request failed:', error);
        throw error;
      });
    }
    
    // Initialize member theme
    function initializeMemberTheme() {
      const memberBanner = document.getElementById('member-info-banner');
      const memberContent = document.getElementById('member-info-content');
      
      if (isMemberTheme) {
        document.body.classList.add('member-theme');
        
        memberContent.innerHTML = `
          <div class="member-badge">${mockMembershipData.membershipType}</div>
          <div>Credits Available: <span class="member-badge">$${mockMembershipData.credits}</span></div>
        `;
        
        memberBanner.style.display = 'block';
      } else {
        document.body.classList.remove('member-theme');
        memberBanner.style.display = 'none';
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, starting conversation');
      startConversation();
    });
    
    function startConversation() {
      console.log('Starting conversation');
      const container = document.getElementById('messages');
      container.innerHTML = '';
      conversationState = 'start';
      
      // Reset state
      resetBookingState();
      clientType = null;
      treatmentType = null;
      isMemberTheme = false;
      availableStaff = [];
      availableServices = [];
      clientInfo = {};
      
      // Reset theme
      initializeMemberTheme();
      
      addMessage('system', "Hi! Welcome to Plump. I'll help you book your appointment.", function() {
        addMessage('system', "First, let me know what type of client you are:", function() {
          showClientTypeSelection();
        });
      });
    }
    
    function addMessage(type, text, callback) {
      const container = document.getElementById('messages');
      
      if (type === 'system') {
        showTyping(function() {
          const message = document.createElement('div');
          message.className = 'message ' + type;
          
          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';
          bubble.innerHTML = text;
          
          message.appendChild(bubble);
          container.appendChild(message);
          scrollToBottom();
          
          if (callback) {
            setTimeout(callback, 500);
          }
        });
      } else {
        const message = document.createElement('div');
        message.className = 'message ' + type;
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        
        message.appendChild(bubble);
        container.appendChild(message);
        scrollToBottom();
        
        if (callback) {
          setTimeout(callback, 300);
        }
      }
    }
    
    function showTyping(callback) {
      const container = document.getElementById('messages');
      const typingMessage = document.createElement('div');
      typingMessage.className = 'message system';
      typingMessage.id = 'typing-indicator';
      
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'typing-indicator';
      
      const typingDots = document.createElement('div');
      typingDots.className = 'typing-dots';
      
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        typingDots.appendChild(dot);
      }
      
      typingIndicator.appendChild(typingDots);
      typingMessage.appendChild(typingIndicator);
      container.appendChild(typingMessage);
      scrollToBottom();
      
      setTimeout(function() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
          indicator.remove();
        }
        callback();
      }, 1200);
    }
    
    function showClientTypeSelection() {
      console.log('Showing client type selection');
      const container = document.getElementById('messages');
      const clientTypeMessage = document.createElement('div');
      clientTypeMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const grid = document.createElement('div');
      grid.className = 'client-type-grid';
      
      // Returning Client button
      const returningButton = document.createElement('button');
      returningButton.className = 'client-type-button';
      returningButton.onclick = () => selectClientType('returning');
      
      const returningTitle = document.createElement('div');
      returningTitle.className = 'client-type-title';
      returningTitle.textContent = 'Returning Client';
      
      const returningDesc = document.createElement('div');
      returningDesc.className = 'client-type-desc';
      returningDesc.textContent = 'Welcome back! Continue with your booking';
      
      returningButton.appendChild(returningTitle);
      returningButton.appendChild(returningDesc);
      
      // New Client button
      const newButton = document.createElement('button');
      newButton.className = 'client-type-button';
      newButton.onclick = () => selectClientType('new');
      
      const newTitle = document.createElement('div');
      newTitle.className = 'client-type-title';
      newTitle.textContent = 'New Client';
      
      const newDesc = document.createElement('div');
      newDesc.className = 'client-type-desc';
      newDesc.textContent = 'First time at Plump? Let\'s get you started';
      
      newButton.appendChild(newTitle);
      newButton.appendChild(newDesc);
      
      // Member button
      const memberButton = document.createElement('button');
      memberButton.className = 'client-type-button member-option';
      memberButton.onclick = () => selectClientType('member');
      
      const memberTitle = document.createElement('div');
      memberTitle.className = 'client-type-title';
      memberTitle.textContent = 'Member';
      
      const memberDesc = document.createElement('div');
      memberDesc.className = 'client-type-desc';
      memberDesc.textContent = 'Exclusive access and priority booking';
      
      memberButton.appendChild(memberTitle);
      memberButton.appendChild(memberDesc);
      
      grid.appendChild(returningButton);
      grid.appendChild(newButton);
      grid.appendChild(memberButton);
      
      bubble.appendChild(grid);
      clientTypeMessage.appendChild(bubble);
      container.appendChild(clientTypeMessage);
      scrollToBottom();
    }
    
    function selectClientType(type) {
      clientType = type;
      
      // Set member theme if member is selected
      if (type === 'member') {
        isMemberTheme = true;
        initializeMemberTheme();
      }
      
      let clientTypeText = type === 'returning' ? 'Returning Client' : 
                          type === 'new' ? 'New Client' : 'Member';
      
      addMessage('user', clientTypeText);
      addMessage('system', 'Perfect! Now, what type of treatment are you interested in?', function() {
        showTreatmentTypeSelection();
      });
    }
    
    function showTreatmentTypeSelection() {
      console.log('Showing treatment type selection');
      const container = document.getElementById('messages');
      const treatmentMessage = document.createElement('div');
      treatmentMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const grid = document.createElement('div');
      grid.className = 'client-type-grid'; // Reuse the same styling
      
      // Injectable button
      const injectableButton = document.createElement('button');
      injectableButton.className = 'client-type-button';
      injectableButton.onclick = () => selectTreatmentType('injectable');
      
      const injectableTitle = document.createElement('div');
      injectableTitle.className = 'client-type-title';
      injectableTitle.textContent = 'Injectable Treatments';
      
      const injectableDesc = document.createElement('div');
      injectableDesc.className = 'client-type-desc';
      injectableDesc.textContent = 'Botox, fillers, and other injectable services';
      
      injectableButton.appendChild(injectableTitle);
      injectableButton.appendChild(injectableDesc);
      
      // Skin treatments button
      const skinButton = document.createElement('button');
      skinButton.className = 'client-type-button';
      skinButton.onclick = () => selectTreatmentType('skin');
      
      const skinTitle = document.createElement('div');
      skinTitle.className = 'client-type-title';
      skinTitle.textContent = 'Skin Treatments';
      
      const skinDesc = document.createElement('div');
      skinDesc.className = 'client-type-desc';
      skinDesc.textContent = 'Laser, microneedling, and skincare services';
      
      skinButton.appendChild(skinTitle);
      skinButton.appendChild(skinDesc);
      
      // Staff Schedule button (NEW)
      const scheduleButton = document.createElement('button');
      scheduleButton.className = 'client-type-button';
      scheduleButton.onclick = () => selectTreatmentType('staff-schedule');
      
      const scheduleTitle = document.createElement('div');
      scheduleTitle.className = 'client-type-title';
      scheduleTitle.textContent = 'See Staff Availability';
      
      const scheduleDesc = document.createElement('div');
      scheduleDesc.className = 'client-type-desc';
      scheduleDesc.textContent = 'View your preferred provider\'s schedule across all locations';
      
      scheduleButton.appendChild(scheduleTitle);
      scheduleButton.appendChild(scheduleDesc);
      
      grid.appendChild(injectableButton);
      grid.appendChild(skinButton);
      grid.appendChild(scheduleButton);
      
      bubble.appendChild(grid);
      treatmentMessage.appendChild(bubble);
      container.appendChild(treatmentMessage);
      scrollToBottom();
    }
    
    function selectTreatmentType(type) {
      // Reset state when changing treatment type
      resetBookingState();
      
      treatmentType = type;
      
      if (type === 'staff-schedule') {
        addMessage('user', 'See Staff Availability');
        addMessage('system', 'Perfect! Let me load our team and their availability across all locations...', function() {
          loadInjectorsForAvailability();
        });
      } else {
        let treatmentText = type === 'injectable' ? 'Injectable Treatments' : 'Skin Treatments';
        addMessage('user', treatmentText);
        addMessage('system', 'Great! Please select your preferred location:', function() {
          showLocationSelection();
        });
      }
    }
    
    // NEW: Load injectors specifically for availability view
    function loadInjectorsForAvailability() {
      console.log('üîç Loading injectors for availability view...');
      
      // Show loading state
      const container = document.getElementById('messages');
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = 'Loading our team of providers...';
      
      loadingMessage.appendChild(bubble);
      container.appendChild(loadingMessage);
      scrollToBottom();
      
      // Get all locations and their staff
      const locationEntries = Object.entries(LOCATIONS_DATA);
      console.log('üîç Loading staff from all locations for availability view');
      
      const allStaffPromises = locationEntries.map(([locationName, locationData]) => {
        const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
          locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
        
        const query = `
          mutation CreateTempCart($locationId: ID!) {
            createCart(input: { locationId: $locationId }) {
              cart {
                id
                availableCategories {
                  name
                  availableItems {
                    id
                    name
                    ... on CartAvailableBookableItem {
                      staffVariants {
                        id
                        staff {
                          id
                          firstName
                          lastName
                          nickname
                          avatar
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        `;
        
        return makeBoulevardRequest(query, { locationId: locationId })
          .then(data => ({
            locationName: locationName,
            locationId: locationId,
            cart: data.createCart.cart
          }))
          .catch(error => {
            console.error('üîç Failed to load from location:', locationName, error);
            return { locationName: locationName, locationId: locationId, cart: null };
          });
      });
      
      Promise.all(allStaffPromises)
        .then(responses => {
          const staffMap = new Map();
          
          responses.forEach(response => {
            if (!response.cart) return;
            
            const { locationName, cart } = response;
            
            if (cart.availableCategories) {
              cart.availableCategories.forEach(category => {
                if (category.availableItems) {
                  category.availableItems.forEach(item => {
                    if (item.staffVariants && item.staffVariants.length > 0) {
                      item.staffVariants.forEach(variant => {
                        if (variant.staff) {
                          if (!staffMap.has(variant.staff.id)) {
                            staffMap.set(variant.staff.id, {
                              id: variant.staff.id,
                              firstName: variant.staff.firstName,
                              lastName: variant.staff.lastName,
                              nickname: variant.staff.nickname,
                              avatar: variant.staff.avatar ? { url: variant.staff.avatar } : null,
                              locations: [locationName]
                            });
                          } else {
                            const staff = staffMap.get(variant.staff.id);
                            if (!staff.locations.includes(locationName)) {
                              staff.locations.push(locationName);
                            }
                          }
                        }
                      });
                    }
                  });
                }
              });
            }
          });
          
          const staffList = Array.from(staffMap.values());
          
          if (staffList.length > 0) {
            console.log('‚úÖ Successfully loaded staff for availability view:', staffList);
            availableStaff = staffList;
            assignLocationColors(staffList);
            showInjectorsForAvailability();
          } else {
            console.log('‚ùå No staff found, using mock data');
            loadMockStaffForAvailability();
          }
        })
        .catch(error => {
          console.error('‚ùå Failed to load staff:', error);
          loadMockStaffForAvailability();
        });
    }
    
    function loadMockStaffForAvailability() {
      const mockStaff = [
        { id: 'staff1', firstName: 'Sivan', lastName: '', avatar: null, locations: ['West Village', 'SoHo'] },
        { id: 'staff2', firstName: 'Hannah', lastName: '', avatar: null, locations: ['Tribeca', 'Williamsburg'] },
        { id: 'staff3', firstName: 'Amber', lastName: '', avatar: null, locations: ['Hoboken', 'Uptown'] },
        { id: 'staff4', firstName: 'Sara', lastName: '', avatar: null, locations: ['Miami', 'West Village'] },
        { id: 'staff5', firstName: 'Alyssa', lastName: 'Lyons', avatar: null, locations: ['SoHo', 'Tribeca'] },
        { id: 'staff6', firstName: 'Macy', lastName: '', avatar: null, locations: ['Williamsburg', 'Hoboken'] },
        { id: 'staff7', firstName: 'Kaley', lastName: '', avatar: null, locations: ['Uptown', 'Miami'] },
        { id: 'staff8', firstName: 'Paige', lastName: '', avatar: null, locations: ['West Village', 'Tribeca', 'SoHo'] },
        { id: 'staff9', firstName: 'Samantha', lastName: '', avatar: null, locations: ['Williamsburg', 'Uptown'] },
        { id: 'staff10', firstName: 'Felisha', lastName: '', avatar: null, locations: ['Hoboken', 'Miami'] },
        { id: 'staff11', firstName: 'Erica', lastName: '', avatar: null, locations: ['West Village', 'SoHo'] },
        { id: 'staff12', firstName: 'Kiki', lastName: '', avatar: null, locations: ['Tribeca', 'Williamsburg'] },
        { id: 'staff13', firstName: 'Nick', lastName: '', avatar: null, locations: ['Hoboken', 'Uptown'] },
        { id: 'staff14', firstName: 'Michelle', lastName: '', avatar: null, locations: ['Miami', 'West Village'] },
        { id: 'staff15', firstName: 'Caitlin', lastName: '', avatar: null, locations: ['SoHo', 'Tribeca'] },
        { id: 'staff16', firstName: 'Emily', lastName: '', avatar: null, locations: ['Williamsburg', 'Hoboken'] },
        { id: 'staff17', firstName: 'Diamond', lastName: '', avatar: null, locations: ['Uptown', 'Miami'] },
        { id: 'staff18', firstName: 'Brittany', lastName: '', avatar: null, locations: ['West Village', 'SoHo'] },
        { id: 'staff19', firstName: 'Julia', lastName: '', avatar: null, locations: ['Tribeca', 'Williamsburg'] },
        { id: 'staff20', firstName: 'Dr.', lastName: 'Blinski', avatar: null, locations: ['Miami', 'West Village'] }
      ];
      
      availableStaff = mockStaff;
      assignLocationColors(mockStaff);
      showInjectorsForAvailability();
    }
    
    function assignLocationColors(staffList) {
      const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6', '#AF52DE', '#FF2D92', '#64D2FF'];
      const allLocations = new Set();
      
      staffList.forEach(staff => {
        staff.locations.forEach(location => allLocations.add(location));
      });
      
      const locationArray = Array.from(allLocations);
      locationColors = {};
      
      locationArray.forEach((location, index) => {
        locationColors[location] = colors[index % colors.length];
      });
      
      console.log('üé® Assigned location colors:', locationColors);
    }
    
    function showInjectorsForAvailability() {
      console.log('üé® Showing injectors for availability view');
      
      // Remove loading message
      const messages = document.querySelectorAll('.message');
      const lastMessage = messages[messages.length - 1];
      if (lastMessage && lastMessage.textContent.includes('Loading our team')) {
        lastMessage.remove();
      }
      
      const container = document.getElementById('messages');
      const injectorsMessage = document.createElement('div');
      injectorsMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = 'Select a provider to view their availability across all locations:';
      
      const injectorContainer = document.createElement('div');
      injectorContainer.className = 'injector-container';
      
      const injectorList = document.createElement('div');
      injectorList.className = 'injector-list';
      
      // Show individual injectors
      availableStaff.forEach((staff, index) => {
        const item = document.createElement('div');
        item.className = 'injector-item';
        item.onclick = () => selectInjectorForAvailability(staff);
        
        const photo = document.createElement('div');
        photo.className = 'injector-photo';
        if (staff.avatar && staff.avatar.url) {
          photo.style.backgroundImage = `url(${staff.avatar.url})`;
        }
        
        const name = document.createElement('div');
        name.className = 'injector-name';
        const fullName = staff.lastName ? `${staff.firstName} ${staff.lastName}` : staff.firstName;
        name.textContent = fullName;
        
        // Add location info
        const locations = document.createElement('div');
        locations.style.fontSize = '0.8rem';
        locations.style.color = isMemberTheme ? '#999' : '#86868b';
        locations.style.marginTop = '4px';
        locations.textContent = staff.locations.join(', ');
        
        const info = document.createElement('div');
        info.style.flex = '1';
        info.appendChild(name);
        info.appendChild(locations);
        
        item.appendChild(photo);
        item.appendChild(info);
        
        injectorList.appendChild(item);
      });
      
      injectorContainer.appendChild(injectorList);
      bubble.appendChild(injectorContainer);
      
      injectorsMessage.appendChild(bubble);
      container.appendChild(injectorsMessage);
      scrollToBottom();
    }
    
    function selectInjectorForAvailability(staff) {
      resetBookingState(); // Reset when selecting injector
      
      const fullName = staff.lastName ? `${staff.firstName} ${staff.lastName}` : staff.firstName;
      selectedInjector = fullName;
      selectedInjectorId = staff.id;
      injectorLocations = staff.locations;
      
      // Initialize all locations as visible
      visibleLocations = new Set(staff.locations);
      
      addMessage('user', selectedInjector);
      
      // Check if staff member has a corresponding "Book By Staff" service
      const staffService = STAFF_SERVICES_MAPPING[fullName];
      if (staffService) {
        addMessage('system', `Perfect! Loading ${selectedInjector}'s availability across all locations...`, function() {
          loadInjectorAvailabilityAcrossLocations();
        });
      } else {
        addMessage('system', `Perfect! Loading ${selectedInjector}'s availability across all locations...`, function() {
          loadInjectorAvailabilityAcrossLocations();
        });
      }
    }
    
    function loadInjectorAvailabilityAcrossLocations() {
      console.log('üîç Loading availability for injector across all locations');
      
      const promises = injectorLocations.map(locationName => {
        return loadInjectorAvailabilityForLocation(locationName);
      });
      
      Promise.all(promises)
        .then(() => {
          console.log('‚úÖ Loaded availability for all locations');
          showInjectorAvailabilityCalendar();
        })
        .catch(error => {
          console.error('‚ùå Failed to load availability:', error);
          showErrorMessage('Unable to load availability. Please try again or contact us.');
        });
    }
    
    function loadInjectorAvailabilityForLocation(locationName) {
      const locationData = LOCATIONS_DATA[locationName];
      if (!locationData) {
        console.error('Location not found:', locationName);
        return Promise.resolve();
      }
      
      const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
        locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
      
      console.log(`üîç Loading availability for ${locationName}`);
      
      // Create a temporary cart for this location
      const createCartQuery = `
        mutation CreateTempCart($locationId: ID!) {
          createCart(input: { locationId: $locationId }) {
            cart {
              id
              availableCategories {
                availableItems {
                  id
                  name
                  ... on CartAvailableBookableItem {
                    staffVariants {
                      id
                      staff {
                        id
                        firstName
                        lastName
                      }
                    }
                  }
                }
              }
            }
          }
        }
      `;
      
      return makeBoulevardRequest(createCartQuery, { locationId: locationId })
        .then(data => {
          const cart = data.createCart.cart;
          
          // Find a service that this injector can perform
          let selectedServiceId = null;
          let selectedStaffVariantId = null;
          
          for (const category of cart.availableCategories) {
            for (const item of category.availableItems) {
              if (item.staffVariants) {
                const staffVariant = item.staffVariants.find(variant => 
                  variant.staff && variant.staff.id === selectedInjectorId
                );
                if (staffVariant) {
                  selectedServiceId = item.id;
                  selectedStaffVariantId = staffVariant.id;
                  break;
                }
              }
            }
            if (selectedServiceId) break;
          }
          
          if (!selectedServiceId) {
            console.log(`No services found for injector at ${locationName}`);
            return;
          }
          
          // Add service to cart
          const addServiceQuery = `
            mutation AddCartItem($cartId: ID!, $itemId: ID!, $itemStaffVariantId: ID!) {
              addCartSelectedBookableItem(input: {
                id: $cartId,
                itemId: $itemId,
                itemStaffVariantId: $itemStaffVariantId
              }) {
                cart {
                  id
                }
              }
            }
          `;
          
          return makeBoulevardRequest(addServiceQuery, {
            cartId: cart.id,
            itemId: selectedServiceId,
            itemStaffVariantId: selectedStaffVariantId
          }).then(() => {
            // Load availability for the next 30 days
            const promises = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
              const date = new Date(today);
              date.setDate(date.getDate() + i);
              promises.push(loadAvailabilityForInjectorDate(cart.id, date, locationName));
            }
            
            return Promise.all(promises);
          });
        })
        .catch(error => {
          console.error(`Failed to load availability for ${locationName}:`, error);
        });
    }
    
    function loadAvailabilityForInjectorDate(cartId, date, locationName) {
      const dateStr = date.toISOString().split('T')[0];
      
      const query = `
        query GetCartBookableTimes($cartId: ID!, $searchDate: Date!) {
          cartBookableTimes(
            id: $cartId,
            searchDate: $searchDate,
            tz: "America/New_York"
          ) {
            id
            startTime
          }
        }
      `;
      
      return makeBoulevardRequest(query, { 
        cartId: cartId, 
        searchDate: dateStr 
      })
        .then(data => {
          const times = data.cartBookableTimes || [];
          
          if (!injectorAvailabilityData[dateStr]) {
            injectorAvailabilityData[dateStr] = {};
          }
          
          injectorAvailabilityData[dateStr][locationName] = times;
          return times;
        })
        .catch(error => {
          console.error('Failed to load availability for', dateStr, locationName, error);
          if (!injectorAvailabilityData[dateStr]) {
            injectorAvailabilityData[dateStr] = {};
          }
          injectorAvailabilityData[dateStr][locationName] = [];
          return [];
        });
    }
    
    function showInjectorAvailabilityCalendar() {
      const container = document.getElementById('messages');
      const calendarMessage = document.createElement('div');
      calendarMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      // Location legend and toggle
      const legend = document.createElement('div');
      legend.className = 'location-legend';
      
      const legendTitle = document.createElement('div');
      legendTitle.className = 'legend-title';
      legendTitle.textContent = 'Locations (click to toggle):';
      
      const legendItems = document.createElement('div');
      legendItems.className = 'legend-items';
      
      injectorLocations.forEach(locationName => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        if (!visibleLocations.has(locationName)) {
          legendItem.classList.add('inactive');
        }
        
        legendItem.onclick = () => toggleLocationVisibility(locationName);
        
        const colorDiv = document.createElement('div');
        colorDiv.className = 'legend-color';
        colorDiv.style.backgroundColor = locationColors[locationName];
        
        const nameDiv = document.createElement('div');
        nameDiv.textContent = locationName;
        
        legendItem.appendChild(colorDiv);
        legendItem.appendChild(nameDiv);
        legendItems.appendChild(legendItem);
      });
      
      legend.appendChild(legendTitle);
      legend.appendChild(legendItems);
      
      // Calendar container
      const availabilityContainer = document.createElement('div');
      availabilityContainer.className = 'availability-container';
      availabilityContainer.id = 'injector-availability-container';
      
      bubble.appendChild(legend);
      bubble.appendChild(availabilityContainer);
      
      // Add "Book with this staff member" button
      const staffService = STAFF_SERVICES_MAPPING[selectedInjector];
      if (staffService) {
        const bookButton = document.createElement('button');
        bookButton.className = 'primary-button';
        bookButton.textContent = `Book Appointment with ${selectedInjector}`;
        bookButton.style.marginTop = '20px';
        bookButton.onclick = () => {
          // Redirect to the specific staff booking service
          addMessage('user', `Book Appointment with ${selectedInjector}`);
          addMessage('system', `Great! I'll connect you to ${staffService}. This will take you to their dedicated booking page...`, function() {
            // Here you would typically redirect or integrate with the staff-specific booking system
            showStaffBookingRedirect(staffService);
          });
        };
        bubble.appendChild(bookButton);
      }
      
      calendarMessage.appendChild(bubble);
      container.appendChild(calendarMessage);
      scrollToBottom();
      
      renderInjectorAvailabilityCalendar();
    }
    
    function showStaffBookingRedirect(staffService) {
      addMessage('system', `You can now proceed to book with this specific provider using their dedicated booking system: "${staffService}". This ensures you get their earliest available appointment across all locations where they work.`);
      
      // Add option to restart or contact
      const container = document.getElementById('messages');
      const optionsMessage = document.createElement('div');
      optionsMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const restartButton = document.createElement('button');
      restartButton.className = 'primary-button';
      restartButton.textContent = 'Start New Booking';
      restartButton.onclick = restartChat;
      
      const contactButton = document.createElement('button');
      contactButton.className = 'secondary-button';
      contactButton.textContent = 'Contact Us for Help';
      contactButton.onclick = () => openSMS('staff-booking-help');
      
      bubble.appendChild(restartButton);
      bubble.appendChild(contactButton);
      
      optionsMessage.appendChild(bubble);
      container.appendChild(optionsMessage);
      scrollToBottom();
    }
    
    function toggleLocationVisibility(locationName) {
      if (visibleLocations.has(locationName)) {
        visibleLocations.delete(locationName);
      } else {
        visibleLocations.add(locationName);
      }
      
      // Update legend items
      const legendItems = document.querySelectorAll('.legend-item');
      legendItems.forEach(item => {
        const locationText = item.textContent;
        if (locationText === locationName) {
          if (visibleLocations.has(locationName)) {
            item.classList.remove('inactive');
          } else {
            item.classList.add('inactive');
          }
        }
      });
      
      // Re-render calendar
      renderInjectorAvailabilityCalendar();
    }
    
    function renderInjectorAvailabilityCalendar() {
      const container = document.getElementById('injector-availability-container');
      container.innerHTML = '';
      
      // Calendar header
      const calendarHeader = document.createElement('div');
      calendarHeader.className = 'calendar-header';
      
      const calendarTitle = document.createElement('div');
      calendarTitle.className = 'calendar-title';
      calendarTitle.textContent = `${selectedInjector}'s Availability`;
      
      calendarHeader.appendChild(calendarTitle);
      
      // Calendar container with scroll
      const calendarContainer = document.createElement('div');
      calendarContainer.className = 'calendar-container';
      
      // Calendar grid
      const calendarGrid = document.createElement('div');
      calendarGrid.className = 'calendar-grid';
      
      // Day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
      });
      
      // Generate calendar for current month
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day disabled';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day injector-calendar-day';
        
        // Check if day is in the past
        if (date < today) {
          dayElement.classList.add('disabled');
        } else {
          dayElement.onclick = () => selectInjectorDate(date);
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        
        const slotsContainer = document.createElement('div');
        slotsContainer.className = 'calendar-slots';
        
        // Add slot indicators for visible locations
        const dayData = injectorAvailabilityData[dateStr];
        if (dayData) {
          let hasSlots = false;
          
          Object.keys(dayData).forEach(locationName => {
            if (!visibleLocations.has(locationName)) return;
            
            const slots = dayData[locationName];
            if (slots && slots.length > 0) {
              hasSlots = true;
              
              // Show up to 3 slot indicators per location
              const slotsToShow = Math.min(3, slots.length);
              for (let i = 0; i < slotsToShow; i++) {
                const slotIndicator = document.createElement('div');
                slotIndicator.className = 'slot-indicator';
                slotIndicator.style.backgroundColor = locationColors[locationName];
                slotIndicator.title = `${locationName} - ${slots.length} slot${slots.length > 1 ? 's' : ''}`;
                slotsContainer.appendChild(slotIndicator);
              }
            }
          });
          
          if (hasSlots) {
            dayElement.classList.add('has-availability');
          }
        }
        
        dayElement.appendChild(dayNumber);
        dayElement.appendChild(slotsContainer);
        calendarGrid.appendChild(dayElement);
      }
      
      calendarContainer.appendChild(calendarGrid);
      
      container.appendChild(calendarHeader);
      container.appendChild(calendarContainer);
      
      // Time slots container (initially hidden)
      const timeSlotsContainer = document.createElement('div');
      timeSlotsContainer.className = 'injector-time-slots';
      timeSlotsContainer.id = 'injector-time-slots-container';
      timeSlotsContainer.style.display = 'none';
      container.appendChild(timeSlotsContainer);
    }
    
    function selectInjectorDate(date) {
      selectedDate = date;
      const dateStr = date.toISOString().split('T')[0];
      
      // Update selected state in calendar
      document.querySelectorAll('.injector-calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      
      // Find and select the clicked day
      const dayElements = document.querySelectorAll('.injector-calendar-day');
      dayElements.forEach(dayElement => {
        const dayNumber = dayElement.querySelector('.day-number');
        if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
          dayElement.classList.add('selected');
        }
      });
      
      showInjectorTimeSlotsForDate(date);
    }
    
    function showInjectorTimeSlotsForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      const dayData = injectorAvailabilityData[dateStr];
      
      const timeSlotsContainer = document.getElementById('injector-time-slots-container');
      timeSlotsContainer.innerHTML = '';
      
      if (!dayData) {
        timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No availability data for this date</p>';
        timeSlotsContainer.style.display = 'block';
        return;
      }
      
      const allSlots = [];
      
      // Collect all slots from visible locations
      Object.keys(dayData).forEach(locationName => {
        if (!visibleLocations.has(locationName)) return;
        
        const slots = dayData[locationName] || [];
        slots.forEach(slot => {
          allSlots.push({
            ...slot,
            locationName: locationName,
            color: locationColors[locationName]
          });
        });
      });
      
      if (allSlots.length === 0) {
        timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No available times for this date</p>';
      } else {
        // Sort slots by time
        allSlots.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        
        allSlots.forEach(slot => {
          const startTime = new Date(slot.startTime);
          const timeStr = startTime.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          
          const timeSlot = document.createElement('div');
          timeSlot.className = 'injector-time-slot';
          timeSlot.onclick = () => selectInjectorTimeSlot(slot, timeStr, date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          }));
          
          const timeDiv = document.createElement('div');
          timeDiv.className = 'slot-time';
          timeDiv.textContent = timeStr;
          
          const locationDiv = document.createElement('div');
          locationDiv.className = 'slot-location';
          
          const colorDiv = document.createElement('div');
          colorDiv.className = 'slot-location-color';
          colorDiv.style.backgroundColor = slot.color;
          
          const nameDiv = document.createElement('div');
          nameDiv.textContent = slot.locationName;
          
          locationDiv.appendChild(colorDiv);
          locationDiv.appendChild(nameDiv);
          
          timeSlot.appendChild(timeDiv);
          timeSlot.appendChild(locationDiv);
          
          timeSlotsContainer.appendChild(timeSlot);
        });
      }
      
      timeSlotsContainer.style.display = 'block';
      scrollToBottom();
    }
    
    function selectInjectorTimeSlot(slot, timeStr, dateStr) {
      selectedTime = { id: slot.id, time: timeStr, date: dateStr, startTime: slot.startTime };
      selectedLocation = slot.locationName;
      selectedLocationId = LOCATIONS_DATA[slot.locationName].locationId;
      
      addMessage('user', `${dateStr} at ${timeStr} - ${slot.locationName}`);
      
      // Check if staff member has a corresponding "Book By Staff" service
      const staffService = STAFF_SERVICES_MAPPING[selectedInjector];
      if (staffService) {
        addMessage('system', `Perfect! I'll connect you to ${staffService} for this specific time slot: ${dateStr} at ${timeStr} at ${slot.locationName}.`, function() {
          showStaffBookingRedirect(staffService);
        });
      } else {
        addMessage('system', `Perfect! I've noted your appointment with ${selectedInjector} at ${slot.locationName} on ${dateStr} at ${timeStr}. Let me prepare your booking...`, function() {
          createCartForInjectorBooking();
        });
      }
    }
    
    function createCartForInjectorBooking() {
      console.log('üéØ Creating cart for injector booking at', selectedLocation);
      
      const formattedLocationId = selectedLocationId.indexOf('urn:blvd:Location:') === 0 ? 
        selectedLocationId : 'urn:blvd:Location:' + selectedLocationId;
      
      const query = `
        mutation CreateCart($locationId: ID!) {
          createCart(input: { locationId: $locationId }) {
            cart {
              id
              availableCategories {
                availableItems {
                  id
                  name
                  ... on CartAvailableBookableItem {
                    staffVariants {
                      id
                      staff {
                        id
                        firstName
                        lastName
                      }
                    }
                  }
                }
              }
            }
          }
        }
      `;
      
      makeBoulevardRequest(query, { locationId: formattedLocationId })
        .then(data => {
          const cart = data.createCart.cart;
          cartId = cart.id;
          
          // Find a service this injector can perform
          let foundService = false;
          for (const category of cart.availableCategories) {
            for (const item of category.availableItems) {
              if (item.staffVariants) {
                const staffVariant = item.staffVariants.find(variant => 
                  variant.staff && variant.staff.id === selectedInjectorId
                );
                if (staffVariant) {
                  // Use the first available service
                  selectedService = item.name;
                  selectedServiceId = item.id;
                  
                  // Add service to cart and continue
                  return addInjectorServiceToCart(staffVariant.id);
                }
              }
            }
          }
          
          if (!foundService) {
            throw new Error('No services found for this injector at this location');
          }
        })
        .catch(error => {
          console.error('Failed to create cart for injector booking:', error);
          showErrorMessage('Unable to prepare booking. Please try again or contact us.');
        });
    }
    
    function addInjectorServiceToCart(staffVariantId) {
      const mutation = `
        mutation AddCartItem($cartId: ID!, $itemId: ID!, $itemStaffVariantId: ID!) {
          addCartSelectedBookableItem(input: {
            id: $cartId,
            itemId: $itemId,
            itemStaffVariantId: $itemStaffVariantId
          }) {
            cart {
              id
            }
          }
        }
      `;
      
      return makeBoulevardRequest(mutation, {
        cartId: cartId,
        itemId: selectedServiceId,
        itemStaffVariantId: staffVariantId
      })
        .then(() => {
          console.log('Service added to cart for injector booking');
          reserveInjectorTimeSlot();
        })
        .catch(error => {
          console.error('Failed to add service for injector booking:', error);
          showErrorMessage('Unable to add service. Please try again or contact us.');
        });
    }
    
    function reserveInjectorTimeSlot() {
      console.log('üîí Reserving injector time slot:', selectedTime.id);
      
      const mutation = `
        mutation ReserveCartBookableItems($cartId: ID!, $bookableTimeId: ID!) {
          reserveCartBookableItems(input: {
            id: $cartId,
            bookableTimeId: $bookableTimeId
          }) {
            cart {
              id
            }
          }
        }
      `;
      
      makeBoulevardRequest(mutation, {
        cartId: cartId,
        bookableTimeId: selectedTime.id
      })
        .then(data => {
          console.log('‚úÖ Injector time slot reserved successfully');
          addMessage('system', `Excellent! I've reserved your time slot with ${selectedInjector}. Now I need your contact information to complete your booking...`);
          showClientInfoForm();
        })
        .catch(error => {
          console.error('‚ùå Failed to reserve injector time slot:', error);
          addMessage('system', `I'm sorry, that time slot is no longer available. Please choose a different time.`);
          showErrorMessage('Time slot is no longer available. Please select a different time.');
        });
    }
    
    function loadInjectors() {
      console.log('üîç Loading injectors from Boulevard API...');
      
      // Show loading state
      addMessage('system', 'Loading our team of injectors...');
      
      // Check all locations to get complete staff list
      const locationEntries = Object.entries(LOCATIONS_DATA);
      
      console.log('üîç Checking locations:', locationEntries.map(([name, data]) => name));
      
      // We'll aggregate staff from all locations and track which locations they work at
      const allStaffPromises = locationEntries.map(([locationName, locationData]) => {
        const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
          locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
        
        console.log('üîç Creating cart for location:', locationName, locationId);
        
        const query = `
          mutation CreateTempCart($locationId: ID!) {
            createCart(input: { locationId: $locationId }) {
              cart {
                id
                availableCategories {
                  name
                  availableItems {
                    id
                    name
                    ... on CartAvailableBookableItem {
                      staffVariants {
                        id
                        staff {
                          id
                          firstName
                          lastName
                          nickname
                          avatar
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        `;
        
        return makeBoulevardRequest(query, { locationId: locationId })
          .then(data => {
            console.log('üîç Response from location:', locationName, data);
            return {
              locationName: locationName,
              locationId: locationId,
              cart: data.createCart.cart
            };
          })
          .catch(error => {
            console.error('üîç Failed to load from location:', locationName, error);
            return {
              locationName: locationName,
              locationId: locationId,
              cart: null,
              error: error.message
            };
          });
      });
      
      Promise.all(allStaffPromises)
        .then(responses => {
          console.log('üîç All cart responses received:', responses);
          
          const staffMap = new Map();
          let totalItemsChecked = 0;
          let totalStaffVariantsFound = 0;
          let locationsWithErrors = [];
          
          responses.forEach(response => {
            if (!response || !response.cart) {
              if (response && response.error) {
                locationsWithErrors.push(`${response.locationName}: ${response.error}`);
              }
              return;
            }
            
            const { locationName, cart } = response;
            console.log(`üîç Processing cart for ${locationName}:`, cart);
            
            if (cart.availableCategories) {
              cart.availableCategories.forEach(category => {
                console.log(`üîç Processing category: ${category.name}`);
                if (category.availableItems) {
                  category.availableItems.forEach(item => {
                    totalItemsChecked++;
                    console.log(`üîç Processing item: ${item.name}`, item.staffVariants);
                    
                    if (item.staffVariants && item.staffVariants.length > 0) {
                      totalStaffVariantsFound += item.staffVariants.length;
                      item.staffVariants.forEach(variant => {
                        if (variant.staff) {
                          console.log(`üîç Processing staff variant:`, variant.staff);
                          if (!staffMap.has(variant.staff.id)) {
                            staffMap.set(variant.staff.id, {
                              id: variant.staff.id,
                              firstName: variant.staff.firstName,
                              lastName: variant.staff.lastName,
                              nickname: variant.staff.nickname,
                              avatar: variant.staff.avatar ? { url: variant.staff.avatar } : null,
                              role: { name: 'Provider' },
                              locations: [locationName] // Track locations
                            });
                          } else {
                            // Add this location to the staff member's locations
                            const staff = staffMap.get(variant.staff.id);
                            if (!staff.locations.includes(locationName)) {
                              staff.locations.push(locationName);
                            }
                          }
                        }
                      });
                    }
                  });
                }
              });
            }
          });
          
          if (locationsWithErrors.length > 0) {
            console.log('üîç Locations with errors:', locationsWithErrors);
          }
          
          console.log(`üîç Summary: ${totalItemsChecked} items checked across all locations, ${totalStaffVariantsFound} staff variants found`);
          
          const staffList = Array.from(staffMap.values());
          console.log('üîç Final staff list with locations:', staffList);
          
          if (staffList.length > 0) {
            console.log('‚úÖ Successfully loaded staff from Boulevard:', staffList);
            console.log('‚úÖ Staff and their locations:', staffList.map(s => 
              `${s.firstName} ${s.lastName}: ${s.locations.join(', ')}`
            ));
            availableStaff = staffList;
            
            // Force refresh the injector display
            console.log('üîÑ Refreshing injector display...');
            showInjectors();
          } else {
            console.log('‚ùå No staff found in Boulevard API, using enhanced mock data');
            loadEnhancedMockStaff();
          }
        })
        .catch(error => {
          console.error('‚ùå Failed to load staff from all locations:', error);
          console.log('‚ùå Falling back to enhanced mock staff data');
          loadEnhancedMockStaff();
        });
    }
    
    function loadEnhancedMockStaff() {
      console.log('Using enhanced mock staff data with more comprehensive team');
      
      const mockStaff = [
        { id: 'staff1', firstName: 'Sivan', lastName: '', role: { name: 'Senior Injector' }, avatar: null, locations: ['West Village', 'SoHo'] },
        { id: 'staff2', firstName: 'Hannah', lastName: '', role: { name: 'Lead Aesthetician' }, avatar: null, locations: ['Tribeca', 'Williamsburg'] },
        { id: 'staff3', firstName: 'Amber', lastName: '', role: { name: 'Injector' }, avatar: null, locations: ['Hoboken', 'Uptown'] },
        { id: 'staff4', firstName: 'Sara', lastName: '', role: { name: 'Medical Director' }, avatar: null, locations: ['Miami', 'West Village'] },
        { id: 'staff5', firstName: 'Alyssa', lastName: 'Lyons', role: { name: 'Senior Injector' }, avatar: null, locations: ['SoHo', 'Tribeca'] },
        { id: 'staff6', firstName: 'Macy', lastName: '', role: { name: 'Aesthetic Nurse' }, avatar: null, locations: ['Williamsburg', 'Hoboken'] },
        { id: 'staff7', firstName: 'Kaley', lastName: '', role: { name: 'Injector' }, avatar: null, locations: ['Uptown', 'Miami'] },
        { id: 'staff8', firstName: 'Paige', lastName: '', role: { name: 'Lead Injector' }, avatar: null, locations: ['West Village', 'Tribeca', 'SoHo'] },
        { id: 'staff9', firstName: 'Samantha', lastName: '', role: { name: 'Aesthetic Specialist' }, avatar: null, locations: ['Williamsburg', 'Uptown'] },
        { id: 'staff10', firstName: 'Felisha', lastName: '', role: { name: 'Senior Aesthetician' }, avatar: null, locations: ['Hoboken', 'Miami'] }
      ];
      
      availableStaff = mockStaff;
      console.log('‚úÖ Enhanced mock staff loaded:', mockStaff.length, 'team members');
      showInjectors();
    }
    
    function showInjectors() {
      console.log('üé® Showing injectors with pill layout');
      
      const container = document.getElementById('messages');
      const injectorsMessage = document.createElement('div');
      injectorsMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const injectorContainer = document.createElement('div');
      injectorContainer.className = 'injector-container';
      
      const injectorList = document.createElement('div');
      injectorList.className = 'injector-list';
      
      // First Available option
      const firstAvailableItem = document.createElement('div');
      firstAvailableItem.className = 'injector-item first-available';
      firstAvailableItem.onclick = () => selectInjector('first-available', 'First Available');
      
      const firstAvailablePhoto = document.createElement('div');
      firstAvailablePhoto.className = 'injector-photo';
      
      const firstAvailableName = document.createElement('div');
      firstAvailableName.className = 'injector-name';
      firstAvailableName.textContent = 'First Available';
      
      firstAvailableItem.appendChild(firstAvailablePhoto);
      firstAvailableItem.appendChild(firstAvailableName);
      
      injectorList.appendChild(firstAvailableItem);
      
      // Individual injectors
      availableStaff.forEach((staff, index) => {
        console.log(`üé® Creating pill for staff ${index + 1}:`, staff);
        
        const item = document.createElement('div');
        item.className = 'injector-item';
        const fullName = staff.lastName ? `${staff.firstName} ${staff.lastName}` : staff.firstName;
        item.onclick = () => selectInjector(staff.id, fullName);
        
        const photo = document.createElement('div');
        photo.className = 'injector-photo';
        if (staff.avatar && staff.avatar.url) {
          photo.style.backgroundImage = `url(${staff.avatar.url})`;
        }
        
        const name = document.createElement('div');
        name.className = 'injector-name';
        name.textContent = fullName;
        
        item.appendChild(photo);
        item.appendChild(name);
        
        injectorList.appendChild(item);
      });
      
      injectorContainer.appendChild(injectorList);
      bubble.appendChild(injectorContainer);
      
      const smsButton = document.createElement('button');
      smsButton.className = 'secondary-button';
      smsButton.textContent = "Don't see your preferred injector? Contact us";
      smsButton.onclick = () => openSMS('injector-inquiry');
      bubble.appendChild(smsButton);
      
      injectorsMessage.appendChild(bubble);
      container.appendChild(injectorsMessage);
      scrollToBottom();
      
      console.log('üé® Injector pill display complete');
    }
    
    function selectInjector(injectorId, injectorName) {
      resetBookingState(); // Reset when selecting injector
      
      selectedInjector = injectorName;
      selectedInjectorId = injectorId;
      addMessage('user', injectorName);
      
      // Show locations for the selected injector
      addMessage('system', 'Perfect! Now please select your preferred location:', function() {
        showLocationSelection();
      });
    }
    
    function showLocationSelection() {
      const container = document.getElementById('messages');
      const locationMessage = document.createElement('div');
      locationMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const grid = document.createElement('div');
      grid.className = 'client-type-grid'; // Reuse the same styling
      
      let availableLocations = Object.keys(LOCATIONS_DATA);
      
      // If a specific injector is selected, only show their locations
      if (selectedInjectorId && selectedInjectorId !== 'first-available') {
        const selectedStaff = availableStaff.find(s => s.id === selectedInjectorId);
        if (selectedStaff && selectedStaff.locations) {
          availableLocations = selectedStaff.locations;
          console.log(`üéØ Filtering locations for ${selectedStaff.firstName} ${selectedStaff.lastName}:`, availableLocations);
        }
      }
      
      console.log('üè¢ Showing locations:', availableLocations);
      
      availableLocations.forEach(locationName => {
        const button = document.createElement('button');
        button.className = 'client-type-button'; // Reuse client type button styling
        button.onclick = () => selectLocation(locationName);
        
        const title = document.createElement('div');
        title.className = 'client-type-title';
        title.textContent = locationName;
        
        const desc = document.createElement('div');
        desc.className = 'client-type-desc';
        desc.textContent = 'Select this location';
        
        button.appendChild(title);
        button.appendChild(desc);
        grid.appendChild(button);
      });
      
      bubble.appendChild(grid);
      locationMessage.appendChild(bubble);
      container.appendChild(locationMessage);
      scrollToBottom();
    }
    
    function selectLocation(location) {
      selectedLocation = location;
      selectedLocationId = LOCATIONS_DATA[location].locationId;
      addMessage('user', location);
      
      addMessage('system', `Perfect! Creating your booking session for ${location}...`);
      createCartAndAssignService();
    }
    
    function createCartAndAssignService() {
      const formattedLocationId = selectedLocationId.indexOf('urn:blvd:Location:') === 0 ? 
        selectedLocationId : 'urn:blvd:Location:' + selectedLocationId;
      
      const query = `
        mutation CreateCart($locationId: ID!) {
          createCart(input: { locationId: $locationId }) {
            cart {
              id
              expiresAt
              availableCategories {
                name
                availableItems {
                  id
                  name
                  description
                  ... on CartAvailableBookableItem {
                    listPrice
                    listDuration
                    staffVariants {
                      id
                      price
                      duration
                      staff {
                        id
                        firstName
                        lastName
                      }
                    }
                  }
                }
              }
            }
          }
        }
      `;
      
      makeBoulevardRequest(query, { locationId: formattedLocationId })
        .then(data => {
          const cart = data.createCart.cart;
          cartId = cart.id;
          console.log('Cart created:', cartId);
          
          // Automatically assign a service that the injector can perform
          assignDefaultService(cart);
        })
        .catch(error => {
          console.error('Cart creation failed:', error.message);
          showErrorFallback('Unable to create booking session. Please try again or contact us.');
        });
    }
    
    function assignDefaultService(cart) {
      const categories = cart.availableCategories || [];
      let foundService = false;
      
      for (const category of categories) {
        let categoryItems = category.availableItems || [];
        
        // Filter services by treatment type
        if (treatmentType === 'injectable') {
          categoryItems = categoryItems.filter(item => 
            item.name.toLowerCase().includes('botox') ||
            item.name.toLowerCase().includes('filler') ||
            item.name.toLowerCase().includes('inject') ||
            item.name.toLowerCase().includes('dysport') ||
            category.name.toLowerCase().includes('inject')
          );
        } else if (treatmentType === 'skin') {
          categoryItems = categoryItems.filter(item => 
            item.name.toLowerCase().includes('laser') ||
            item.name.toLowerCase().includes('microneedling') ||
            item.name.toLowerCase().includes('facial') ||
            item.name.toLowerCase().includes('peel') ||
            category.name.toLowerCase().includes('skin')
          );
        }
        
        for (const item of categoryItems) {
          // Get staff variants for this service
          let staffVariants = item.staffVariants || [];
          
          // If we have a specific injector selected, filter to only their variants
          if (selectedInjectorId && selectedInjectorId !== 'first-available') {
            staffVariants = staffVariants.filter(variant => 
              variant.staff && variant.staff.id === selectedInjectorId
            );
          }
          
          // If we found a service this injector can perform, use it
          if (staffVariants.length > 0) {
            selectedService = item.name;
            selectedServiceId = item.id;
            
            console.log('üéØ Auto-assigned service:', selectedService);
            const treatmentLabel = treatmentType === 'injectable' ? 'injectable treatment' : 'skin treatment';
            addMessage('system', `Great! I've assigned ${selectedService} for your ${treatmentLabel} appointment. Now let me find available times...`);
            
            // Add the service to cart and proceed
            addServiceToCart(staffVariants[0].id);
            foundService = true;
            break;
          }
        }
        
        if (foundService) break;
      }
      
      if (!foundService) {
        console.log('‚ùå No services found for this injector at this location');
        const treatmentLabel = treatmentType === 'injectable' ? 'injectable treatments' : 'skin treatments';
        showErrorFallback(`No ${treatmentLabel} available for this injector at this location. Please try a different combination.`);
      }
    }
    
    function addServiceToCart(staffVariantId = null) {
      const mutation = `
        mutation AddCartItem($cartId: ID!, $itemId: ID!, $itemStaffVariantId: ID) {
          addCartSelectedBookableItem(input: {
            id: $cartId,
            itemId: $itemId,
            itemStaffVariantId: $itemStaffVariantId
          }) {
            cart {
              id
              selectedItems {
                id
              }
            }
          }
        }
      `;
      
      const variables = { 
        cartId: cartId, 
        itemId: selectedServiceId 
      };
      
      // Add staff variant if provided
      if (staffVariantId) {
        variables.itemStaffVariantId = staffVariantId;
      }
      
      console.log('üéØ Adding service to cart with variables:', variables);
      
      makeBoulevardRequest(mutation, variables)
        .then(data => {
          console.log('Service added to cart');
          loadCalendarAvailability();
        })
        .catch(error => {
          console.error('Failed to add service:', error.message);
          showErrorFallback('Unable to add service. Please try again or contact us.');
        });
    }
    
    function loadCalendarAvailability() {
      addMessage('system', 'Here are the available appointment times:', function() {
        showCalendarView();
        loadAvailabilityForMonth();
      });
    }
    
    function showCalendarView() {
      const container = document.getElementById('messages');
      const calendarMessage = document.createElement('div');
      calendarMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const availabilityContainer = document.createElement('div');
      availabilityContainer.className = 'availability-container';
      availabilityContainer.id = 'availability-container';
      
      bubble.appendChild(availabilityContainer);
      
      const smsButton = document.createElement('button');
      smsButton.className = 'secondary-button';
      smsButton.textContent = "Don't see a good time? Contact us";
      smsButton.onclick = () => openSMS('time-inquiry');
      bubble.appendChild(smsButton);
      
      calendarMessage.appendChild(bubble);
      container.appendChild(calendarMessage);
      scrollToBottom();
    }
    
    function renderCalendar() {
      const container = document.getElementById('availability-container');
      container.innerHTML = '';
      
      // Calendar header with navigation
      const calendarHeader = document.createElement('div');
      calendarHeader.className = 'calendar-header';
      
      const prevButton = document.createElement('button');
      prevButton.className = 'calendar-nav';
      prevButton.textContent = '‚Üê Previous';
      prevButton.onclick = () => navigateMonth(-1);
      
      const calendarTitle = document.createElement('div');
      calendarTitle.className = 'calendar-title';
      calendarTitle.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      
      const nextButton = document.createElement('button');
      nextButton.className = 'calendar-nav';
      nextButton.textContent = 'Next ‚Üí';
      nextButton.onclick = () => navigateMonth(1);
      
      calendarHeader.appendChild(prevButton);
      calendarHeader.appendChild(calendarTitle);
      calendarHeader.appendChild(nextButton);
      
      // Calendar container with scroll
      const calendarContainer = document.createElement('div');
      calendarContainer.className = 'calendar-container';
      
      // Calendar grid
      const calendarGrid = document.createElement('div');
      calendarGrid.className = 'calendar-grid';
      
      // Day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
      });
      
      // Generate calendar days
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const today = new Date();
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day disabled';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Check if day is in the past
        if (date < today) {
          dayElement.classList.add('disabled');
        } else {
          dayElement.onclick = () => selectCalendarDate(date);
          
          // Check if this day has availability
          if (calendarAvailability[dateStr] && calendarAvailability[dateStr].length > 0) {
            dayElement.classList.add('has-availability');
          }
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        
        const dayAvailability = document.createElement('div');
        dayAvailability.className = 'day-availability';
        if (calendarAvailability[dateStr] && calendarAvailability[dateStr].length > 0) {
          dayAvailability.textContent = `${calendarAvailability[dateStr].length} slots`;
        }
        
        dayElement.appendChild(dayNumber);
        dayElement.appendChild(dayAvailability);
        calendarGrid.appendChild(dayElement);
      }
      
      calendarContainer.appendChild(calendarGrid);
      
      container.appendChild(calendarHeader);
      container.appendChild(calendarContainer);
      
      // Time slots container (initially hidden)
      const timeSlotsContainer = document.createElement('div');
      timeSlotsContainer.className = 'time-slots';
      timeSlotsContainer.id = 'time-slots-container';
      timeSlotsContainer.style.display = 'none';
      container.appendChild(timeSlotsContainer);
    }
    
    function navigateMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
      loadAvailabilityForMonth();
    }
    
    function loadAvailabilityForMonth() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // Load availability for all days in the month
      const promises = [];
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        if (date >= new Date()) { // Only load for future dates
          promises.push(loadAvailabilityForDate(date));
        }
      }
      
      Promise.all(promises).then(() => {
        renderCalendar();
      });
    }
    
    function loadAvailabilityForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      
      const query = `
        query GetCartBookableTimes($cartId: ID!, $searchDate: Date!) {
          cartBookableTimes(
            id: $cartId,
            searchDate: $searchDate,
            tz: "America/New_York"
          ) {
            id
            startTime
          }
        }
      `;
      
      return makeBoulevardRequest(query, { 
        cartId: cartId, 
        searchDate: dateStr 
      })
        .then(data => {
          const times = data.cartBookableTimes || [];
          calendarAvailability[dateStr] = times;
          return times;
        })
        .catch(error => {
          console.error('Failed to load availability for', dateStr, error);
          calendarAvailability[dateStr] = [];
          return [];
        });
    }
    
    function selectCalendarDate(date) {
      selectedDate = date;
      const dateStr = date.toISOString().split('T')[0];
      
      // Update selected state in calendar
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      
      // Find and select the clicked day
      const dayElements = document.querySelectorAll('.calendar-day');
      dayElements.forEach(dayElement => {
        const dayNumber = dayElement.querySelector('.day-number');
        if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
          dayElement.classList.add('selected');
        }
      });
      
      // Show time slots for this date
      showTimeSlotsForDate(date);
    }
    
    function showTimeSlotsForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      const times = calendarAvailability[dateStr] || [];
      
      const timeSlotsContainer = document.getElementById('time-slots-container');
      timeSlotsContainer.innerHTML = '';
      
      if (times.length === 0) {
        timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No available times for this date</p>';
      } else {
        times.forEach(time => {
          const startTime = new Date(time.startTime);
          const timeStr = startTime.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          
          const timeSlot = document.createElement('div');
          timeSlot.className = 'time-slot';
          timeSlot.textContent = timeStr;
          timeSlot.onclick = () => selectTime(time.id, timeStr, date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          }), time.startTime);
          
          timeSlotsContainer.appendChild(timeSlot);
        });
      }
      
      timeSlotsContainer.style.display = 'block';
      scrollToBottom();
    }
    
    function selectTime(timeId, timeStr, dateStr, startTime) {
      selectedTime = { id: timeId, time: timeStr, date: dateStr, startTime: startTime };
      addMessage('user', `${dateStr} at ${timeStr}`);
      
      addMessage('system', `Perfect! I've noted your preferred time: ${dateStr} at ${timeStr}. Let me reserve this time slot...`);
      
      // Reserve the time slot before showing the form
      reserveTimeSlot();
    }
    
    function reserveTimeSlot() {
      console.log('üîí Reserving time slot:', selectedTime.id);
      
      const mutation = `
        mutation ReserveCartBookableItems($cartId: ID!, $bookableTimeId: ID!) {
          reserveCartBookableItems(input: {
            id: $cartId,
            bookableTimeId: $bookableTimeId
          }) {
            cart {
              id
            }
          }
        }
      `;
      
      makeBoulevardRequest(mutation, {
        cartId: cartId,
        bookableTimeId: selectedTime.id
      })
        .then(data => {
          console.log('‚úÖ Time slot reserved successfully');
          addMessage('system', `Great! I've reserved your time slot. Now I need your contact information to complete your booking...`);
          showClientInfoForm();
        })
        .catch(error => {
          console.error('‚ùå Failed to reserve time slot:', error);
          addMessage('system', `I'm sorry, that time slot is no longer available. Please choose a different time.`);
          showErrorMessage('Time slot is no longer available. Please select a different time.');
        });
    }
    
    function showClientInfoForm() {
      setTimeout(function() {
        const container = document.getElementById('messages');
        const formMessage = document.createElement('div');
        formMessage.className = 'message system';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        const formContainer = document.createElement('div');
        formContainer.className = 'form-container';
        
        const contactTitle = document.createElement('div');
        contactTitle.className = 'form-section-title';
        contactTitle.textContent = 'Contact Information';
        
        const nameRow = document.createElement('div');
        nameRow.className = 'form-row';
        
        const firstNameInput = document.createElement('input');
        firstNameInput.type = 'text';
        firstNameInput.className = 'form-input';
        firstNameInput.id = 'firstName';
        firstNameInput.placeholder = 'First Name';
        
        const lastNameInput = document.createElement('input');
        lastNameInput.type = 'text';
        lastNameInput.className = 'form-input';
        lastNameInput.id = 'lastName';
        lastNameInput.placeholder = 'Last Name';
        
        nameRow.appendChild(firstNameInput);
        nameRow.appendChild(lastNameInput);
        
        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.className = 'form-input';
        emailInput.id = 'email';
        emailInput.placeholder = 'Email Address';
        
        const phoneInput = document.createElement('input');
        phoneInput.type = 'tel';
        phoneInput.className = 'form-input';
        phoneInput.id = 'phone';
        phoneInput.placeholder = 'Phone Number';
        
        const submitButton = document.createElement('button');
        submitButton.className = 'primary-button';
        submitButton.textContent = 'Complete Booking';
        submitButton.onclick = completeBooking;
        
        formContainer.appendChild(contactTitle);
        formContainer.appendChild(nameRow);
        formContainer.appendChild(emailInput);
        formContainer.appendChild(phoneInput);
        formContainer.appendChild(submitButton);
        
        bubble.appendChild(formContainer);
        formMessage.appendChild(bubble);
        container.appendChild(formMessage);
        scrollToBottom();
        
        setTimeout(() => firstNameInput.focus(), 100);
      }, 1000);
    }
    
    function completeBooking() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      
      // Clear previous errors
      document.querySelectorAll('.form-input').forEach(input => input.classList.remove('error'));
      document.querySelectorAll('.error-text').forEach(error => error.remove());
      
      let hasErrors = false;
      
      // Validate contact info
      if (!firstName) {
        showFieldError('firstName', 'First name is required');
        hasErrors = true;
      }
      
      if (!lastName) {
        showFieldError('lastName', 'Last name is required');
        hasErrors = true;
      }
      
      if (!email) {
        showFieldError('email', 'Email is required');
        hasErrors = true;
      } else if (!validateEmail(email)) {
        showFieldError('email', 'Please enter a valid email address');
        hasErrors = true;
      }
      
      if (!phone) {
        showFieldError('phone', 'Phone number is required');
        hasErrors = true;
      } else if (!validatePhoneNumber(phone)) {
        showFieldError('phone', 'Please enter a valid phone number');
        hasErrors = true;
      }
      
      if (hasErrors) return;
      
      clientInfo = { firstName, lastName, email, phoneNumber: phone };
      
      const button = document.querySelector('.primary-button');
      const originalText = button.textContent;
      button.textContent = 'Processing...';
      button.disabled = true;
      
      addMessage('user', `${firstName} ${lastName} - ${email}`);
      
      // Process the booking with Boulevard API
      console.log('‚úÖ Starting booking completion process...');
      
      updateCartWithClientInfo()
        .then(() => {
          console.log('‚úÖ Client info updated, attempting booking completion...');
          return completeAPIBooking();
        })
        .then((result) => {
          console.log('‚úÖ Booking successful:', result);
          
          button.textContent = originalText;
          button.disabled = false;
          
          showBookingSuccess(result);
        })
        .catch(error => {
          button.textContent = originalText;
          button.disabled = false;
          console.error('‚ùå Booking completion failed:', error);
          
          let errorMessage = 'Booking failed. Please contact us to complete your appointment.';
          
          if (error.message.includes('payment')) {
            errorMessage = 'Payment is required to complete this booking. Please contact us.';
          } else if (error.message.includes('permission') || error.message.includes('unauthorized')) {
            errorMessage = 'Unable to complete booking due to permissions. Please contact us.';
          } else if (error.message.includes('time') || error.message.includes('available')) {
            errorMessage = 'The selected time is no longer available. Please choose a different time.';
          }
          
          showErrorMessage(errorMessage);
          
          setTimeout(() => {
            showSMSOption();
          }, 2000);
        });
    }
    
    function updateCartWithClientInfo() {
      console.log('‚úÖ Updating cart with client info...');
      
      const query = `
        mutation UpdateCart($cartId: ID!, $email: Email!, $firstName: String!, $lastName: String!, $phoneNumber: PhoneNumber!) {
          updateCart(input: {
            id: $cartId,
            clientInformation: {
              email: $email,
              firstName: $firstName,
              lastName: $lastName,
              phoneNumber: $phoneNumber
            }
          }) {
            cart {
              id
              clientInformation {
                firstName
                lastName
                email
                phoneNumber
              }
            }
          }
        }
      `;
      
      return makeBoulevardRequest(query, {
        cartId: cartId,
        email: clientInfo.email,
        firstName: clientInfo.firstName,
        lastName: clientInfo.lastName,
        phoneNumber: clientInfo.phoneNumber
      })
      .then(data => {
        console.log('‚úÖ Cart updated with client info:', data);
        return data;
      })
      .catch(error => {
        console.error('‚ùå Update cart failed:', error);
        return Promise.resolve();
      });
    }
    
    function completeAPIBooking() {
      console.log('‚úÖ Completing booking using bookingComplete mutation...');
      
      const mutation = `
        mutation BookingComplete($input: BookingCompleteInput!) {
          bookingComplete(input: $input) {
            booking {
              id
              state
              insertedAt
            }
            bookingAppointments {
              id
              startTime
              endTime
              state
              client {
                id
                firstName
                lastName
                email
                phoneNumber
              }
              location {
                id
                name
              }
              services {
                id
                name
              }
              staff {
                id
                firstName
                lastName
              }
            }
            bookingWarnings {
              field
              message
            }
          }
        }
      `;
      
      const inputVariations = [
        { cartId: cartId },
        { id: cartId },
        { 
          cartId: cartId,
          paymentMethodId: null,
          gratuityAmount: 0
        },
        {
          cartId: cartId,
          paymentMethod: null,
          gratuity: { amount: 0 },
          discountCodes: []
        }
      ];
      
      function tryBookingComplete(variationIndex = 0) {
        if (variationIndex >= inputVariations.length) {
          throw new Error('All booking completion variations failed');
        }
        
        const input = inputVariations[variationIndex];
        console.log(`‚úÖ Trying booking completion variation ${variationIndex + 1}:`, input);
        
        return makeBoulevardRequest(mutation, { input: input })
          .then(data => {
            console.log('‚úÖ Booking completed successfully:', data);
            
            const result = data.bookingComplete;
            
            if (result.bookingWarnings && result.bookingWarnings.length > 0) {
              console.warn('‚ö†Ô∏è Booking warnings:', result.bookingWarnings);
            }
            
            if (result.bookingAppointments && result.bookingAppointments.length > 0) {
              const appointment = result.bookingAppointments[0];
              console.log('‚úÖ Appointment created with ID:', appointment.id);
              
              return {
                success: true,
                bookingId: result.booking.id,
                appointmentId: appointment.id,
                appointment: appointment,
                warnings: result.bookingWarnings
              };
            } else {
              throw new Error('No appointments were created in the booking');
            }
          })
          .catch(error => {
            console.error(`‚ùå Booking variation ${variationIndex + 1} failed:`, error);
            
            if (variationIndex < inputVariations.length - 1) {
              console.log(`‚è≠Ô∏è Trying next variation...`);
              return tryBookingComplete(variationIndex + 1);
            } else {
              throw error;
            }
          });
      }
      
      return tryBookingComplete();
    }
    
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      field.classList.add('error');
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-text';
      errorDiv.textContent = message;
      
      field.parentNode.insertBefore(errorDiv, field.nextSibling);
    }
    
    function showErrorMessage(message) {
      const container = document.getElementById('messages');
      const errorMessage = document.createElement('div');
      errorMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = `<div class="error-message">${message}</div>`;
      
      errorMessage.appendChild(bubble);
      container.appendChild(errorMessage);
      scrollToBottom();
    }
    
    function showBookingSuccess(result) {
      const injectorText = selectedInjector ? `Provider: ${selectedInjector}<br>` : '';
      const bookingIdText = result && result.bookingId ? `<br>Booking ID: ${result.bookingId}` : '';
      const appointmentIdText = result && result.appointmentId ? `<br>Appointment ID: ${result.appointmentId}` : '';
      
      const successMessage = `<div class="success-message"><strong>‚úÖ Booking Completed Successfully!</strong><br><br>` +
                            `Location: ${selectedLocation}<br>` +
                            `Service: ${selectedService}<br>` +
                            `Date & Time: ${selectedTime.date} at ${selectedTime.time}<br>` +
                            `${injectorText}` +
                            `Client: ${clientInfo.firstName} ${clientInfo.lastName}<br>` +
                            `${bookingIdText}${appointmentIdText}<br><br>` +
                            `Your appointment has been confirmed and added to our calendar. You should receive a confirmation email shortly.</div>`;
      
      addMessage('system', successMessage, function() {
        showPostBookingOptions();
      });
    }
    
    function showPostBookingOptions() {
      const container = document.getElementById('messages');
      const optionsMessage = document.createElement('div');
      optionsMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const bookButton = document.createElement('button');
      bookButton.className = 'primary-button';
      bookButton.textContent = 'Book Another Appointment';
      bookButton.onclick = restartChat;
      
      const smsButton = document.createElement('button');
      smsButton.className = 'secondary-button';
      smsButton.textContent = 'Questions? Contact Us';
      smsButton.onclick = () => openSMS('follow-up');
      
      bubble.appendChild(bookButton);
      bubble.appendChild(smsButton);
      
      optionsMessage.appendChild(bubble);
      container.appendChild(optionsMessage);
      scrollToBottom();
    }
    
    function showErrorFallback(message) {
      addMessage('system', message + ' Let me connect you:', function() {
        showSMSOption();
      });
    }
    
    function showSMSOption() {
      const container = document.getElementById('messages');
      const smsMessage = document.createElement('div');
      smsMessage.className = 'message system';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      
      const smsButton = document.createElement('button');
      smsButton.className = 'secondary-button';
      smsButton.textContent = 'Text us at (646) 346-8809';
      smsButton.onclick = () => openSMS('help');
      
      bubble.appendChild(smsButton);
      smsMessage.appendChild(bubble);
      
      container.appendChild(smsMessage);
      scrollToBottom();
    }
    
    function openSMS(context) {
      let message = "I'd like to book an appointment at Plump";
      
      if (context === 'follow-up') {
        message = "I just completed a booking and have a question";
      } else if (context === 'injector-inquiry') {
        message = 'I\'m looking for a specific injector that wasn\'t listed';
      } else if (context === 'time-inquiry') {
        message = `I'm looking for ${selectedService} at ${selectedLocation} but need different time options`;
      } else if (context === 'staff-booking-help') {
        message = `I need help booking with ${selectedInjector}`;
      }
      
      message += ".";
      
      const encodedMessage = encodeURIComponent(message);
      window.location.href = 'sms:+16463468809?body=' + encodedMessage;
    }
    
    function restartChat() {
      startConversation();
    }
    
    function scrollToBottom() {
      const container = document.getElementById('messages');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    console.log('‚úÖ Script fully loaded with staff schedule integration');
  </script>
</body>
</html>

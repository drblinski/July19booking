<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Book Appointment | Get Plump</title>
 
 <style>
   * {
     margin: 0;
     padding: 0;
     box-sizing: border-box;
   }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
     background: #f5f5f7;
     min-height: 100vh;
     display: flex;
     justify-content: center;
     align-items: center;
     padding: 20px;
   }
   
   .booking-widget {
     width: 100%;
     max-width: 800px;
     background: #fff;
     border-radius: 12px;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
     overflow: hidden;
     display: flex;
     flex-direction: column;
     height: 80vh;
     min-height: 600px;
   }
   
   .chat-header {
     background: #ffffff;
     padding: 20px 30px;
     border-bottom: 1px solid #e5e5e7;
     text-align: center;
   }
   
   .chat-title {
     color: #1d1d1f;
     font-size: 1.3rem;
     font-weight: 600;
     margin-bottom: 5px;
   }
   
   .chat-subtitle {
     color: #86868b;
     font-size: 0.95rem;
   }
   
   .messages-container {
     flex: 1;
     padding: 20px 30px;
     overflow-y: auto;
     scroll-behavior: smooth;
     background: #fff;
   }
   
   .message {
     margin-bottom: 20px;
     display: flex;
     animation: slideIn 0.3s ease-out;
     max-width: 100%;
   }
   
   @keyframes slideIn {
     from {
       opacity: 0;
       transform: translateY(10px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }
   
   .message.system {
     justify-content: flex-start;
   }
   
   .message.user {
     justify-content: flex-end;
   }
   
   .message-bubble {
     max-width: 70%;
     padding: 12px 18px;
     border-radius: 18px;
     font-size: 1rem;
     line-height: 1.4;
     word-wrap: break-word;
   }
   
   .message.system .message-bubble {
     background: #e9e9eb;
     color: #1d1d1f;
     border-bottom-left-radius: 4px;
   }
   
   .message.user .message-bubble {
     background: #007AFF;
     color: #fff;
     border-bottom-right-radius: 4px;
   }
   
   .typing-indicator {
     display: flex;
     align-items: center;
     padding: 12px 18px;
     background: #e9e9eb;
     border-radius: 18px;
     border-bottom-left-radius: 4px;
     max-width: 80px;
   }
   
   .typing-dots {
     display: flex;
     gap: 4px;
   }
   
   .dot {
     width: 8px;
     height: 8px;
     background: #86868b;
     border-radius: 50%;
     animation: typing 1.4s infinite;
   }
   
   .dot:nth-child(2) { animation-delay: 0.2s; }
   .dot:nth-child(3) { animation-delay: 0.4s; }
   
   @keyframes typing {
     0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
     30% { transform: translateY(-6px); opacity: 1; }
   }
   
   /* Treatment Type Selection */
   .treatment-grid {
     display: grid;
     grid-template-columns: 1fr;
     gap: 15px;
     margin-top: 15px;
   }
   
   .treatment-button {
     background: #fff;
     border: 2px solid #e5e5e7;
     color: #1d1d1f;
     padding: 20px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.2s ease;
     text-align: center;
     font-size: 1rem;
     font-weight: 500;
   }
   
   .treatment-button:hover {
     border-color: #007AFF;
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
   }
   
   .treatment-title {
     font-weight: 600;
     margin-bottom: 8px;
     font-size: 1.1rem;
   }
   
   .treatment-desc {
     font-size: 0.9rem;
     color: #86868b;
     line-height: 1.3;
   }
   
   /* Improved Injector Display - Vertical List */
   .injector-container {
     margin-top: 15px;
   }
   
   .injector-list {
     display: flex;
     flex-direction: column;
     gap: 10px;
     max-height: 300px;
     overflow-y: auto;
     padding-right: 5px;
   }
   
   .injector-list::-webkit-scrollbar {
     width: 6px;
   }
   
   .injector-list::-webkit-scrollbar-track {
     background: #f1f1f1;
     border-radius: 3px;
   }
   
   .injector-list::-webkit-scrollbar-thumb {
     background: #c1c1c1;
     border-radius: 3px;
   }
   
   .injector-list::-webkit-scrollbar-thumb:hover {
     background: #a8a8a8;
   }
   
   .injector-item {
     background: #fff;
     border: 2px solid #e5e5e7;
     border-radius: 25px;
     padding: 8px 16px;
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     gap: 12px;
     min-height: 50px;
   }
   
   .injector-item:hover {
     border-color: #007AFF;
     transform: translateY(-1px);
     box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
   }
   
   .injector-item.first-available {
     background: #007AFF;
     color: #fff;
     border-color: #007AFF;
   }
   
   .injector-item.first-available:hover {
     background: #0056d6;
     border-color: #0056d6;
   }
   
   .injector-photo {
     width: 35px;
     height: 35px;
     border-radius: 50%;
     background: #e5e5e7;
     background-size: cover;
     background-position: center;
     flex-shrink: 0;
   }
   
   .injector-name {
     font-weight: 600;
     font-size: 0.95rem;
     flex: 1;
     text-align: left;
   }
   
   .injector-item.first-available .injector-name {
     color: #fff;
   }
   
   /* Calendar-style Time Selection */
   .availability-container {
     margin-top: 15px;
   }
   
   .calendar-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 15px;
     padding: 0 10px;
   }
   
   .calendar-nav {
     background: #f0f0f0;
     border: none;
     border-radius: 8px;
     padding: 8px 12px;
     cursor: pointer;
     font-size: 0.9rem;
     transition: all 0.2s ease;
   }
   
   .calendar-nav:hover {
     background: #e0e0e0;
   }
   
   .calendar-nav:disabled {
     opacity: 0.5;
     cursor: not-allowed;
   }
   
   .calendar-title {
     font-weight: 600;
     font-size: 1rem;
     color: #1d1d1f;
   }
   
   .calendar-grid {
     display: grid;
     grid-template-columns: repeat(7, 1fr);
     gap: 8px;
     margin-bottom: 15px;
   }
   
   .calendar-day-header {
     text-align: center;
     font-size: 0.8rem;
     color: #86868b;
     font-weight: 500;
     padding: 8px 4px;
   }
   
   .calendar-day {
     background: #f9f9f9;
     border: 1px solid #e5e5e7;
     border-radius: 8px;
     padding: 8px 4px;
     text-align: center;
     font-size: 0.85rem;
     min-height: 60px;
     cursor: pointer;
     transition: all 0.2s ease;
     display: flex;
     flex-direction: column;
     justify-content: space-between;
   }
   
   .calendar-day:hover {
     background: #f0f8ff;
     border-color: #007AFF;
   }
   
   .calendar-day.has-availability {
     background: #fff;
     border-color: #34c759;
   }
   
   .calendar-day.has-availability:hover {
     background: #f0fff4;
     border-color: #30a752;
   }
   
   .calendar-day.selected {
     background: #007AFF;
     color: #fff;
     border-color: #007AFF;
   }
   
   .calendar-day.disabled {
     opacity: 0.3;
     cursor: not-allowed;
   }
   
   .calendar-day.disabled:hover {
     background: #f9f9f9;
     border-color: #e5e5e7;
   }
   
   .day-number {
     font-weight: 500;
     margin-bottom: 2px;
   }
   
   .day-availability {
     font-size: 0.7rem;
     color: #34c759;
     font-weight: 500;
   }
   
   .calendar-day.selected .day-availability {
     color: rgba(255, 255, 255, 0.8);
   }
   
   .time-slots {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
     gap: 8px;
     max-height: 200px;
     overflow-y: auto;
     padding: 10px;
     background: #f9f9f9;
     border-radius: 8px;
   }
   
   .time-slot {
     background: #fff;
     border: 1px solid #e5e5e7;
     border-radius: 6px;
     padding: 8px;
     text-align: center;
     font-size: 0.85rem;
     cursor: pointer;
     transition: all 0.2s ease;
   }
   
   .time-slot:hover {
     background: #f0f8ff;
     border-color: #007AFF;
   }
   
   /* Location Grid */
   .location-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 15px;
     margin-top: 15px;
   }
   
   .location-button {
     background: #fff;
     border: 2px solid #e5e5e7;
     color: #1d1d1f;
     padding: 15px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.2s ease;
     text-align: center;
     font-size: 0.95rem;
     font-weight: 500;
   }
   
   .location-button:hover {
     border-color: #007AFF;
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
   }
   
   /* Service Grid */
   .service-grid {
     display: grid;
     grid-template-columns: 1fr;
     gap: 12px;
     margin-top: 15px;
     max-height: 350px;
     overflow-y: auto;
   }
   
   .service-button {
     background: #fff;
     border: 2px solid #e5e5e7;
     color: #1d1d1f;
     padding: 18px 20px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.2s ease;
     text-align: left;
     display: flex;
     justify-content: space-between;
     align-items: center;
   }
   
   .service-button:hover {
     border-color: #007AFF;
     transform: translateY(-1px);
     box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
   }
   
   .service-info {
     flex: 1;
   }
   
   .service-name {
     font-weight: 600;
     margin-bottom: 4px;
     font-size: 1rem;
   }
   
   .service-duration {
     font-size: 0.85rem;
     color: #86868b;
   }
   
   .service-description {
     font-size: 0.9rem;
     color: #86868b;
     margin-top: 8px;
     line-height: 1.4;
   }
   
   .service-price {
     font-size: 1rem;
     font-weight: 600;
     color: #007AFF;
   }
   
   .member-price {
     color: #34c759;
     font-size: 0.9rem;
     text-decoration: line-through;
   }
   
   /* Membership Styles */
   .membership-tile {
     background: linear-gradient(135deg, #34c759, #30a752);
     border: none;
     color: #fff;
     padding: 20px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.2s ease;
     text-align: center;
     margin-top: 15px;
   }
   
   .membership-tile:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
   }
   
   .membership-title {
     font-weight: 600;
     font-size: 1.1rem;
     margin-bottom: 8px;
   }
   
   .membership-desc {
     font-size: 0.9rem;
     opacity: 0.9;
   }
   
   .member-status {
     background: #e8f5e8;
     border: 2px solid #c8e6c9;
     color: #2e7d32;
     padding: 15px;
     border-radius: 12px;
     margin-top: 15px;
     text-align: center;
   }
   
   .member-credits {
     font-weight: 600;
     font-size: 1.1rem;
     margin-bottom: 5px;
   }
   
   .member-eligibility {
     font-size: 0.9rem;
     color: #5a8c5a;
   }
   
   /* Form Container */
   .form-container {
     background: #f9f9f9;
     border-radius: 12px;
     padding: 25px;
     margin-top: 15px;
   }
   
   .form-input {
     width: 100%;
     background: #fff;
     border: 2px solid #e5e5e7;
     border-radius: 8px;
     padding: 12px 16px;
     color: #1d1d1f;
     font-size: 1rem;
     margin-bottom: 15px;
     transition: border-color 0.2s ease;
   }
   
   .form-input::placeholder {
     color: #86868b;
   }
   
   .form-input:focus {
     outline: none;
     border-color: #007AFF;
   }
   
   .form-input.error {
     border-color: #ff3b30;
   }
   
   .error-text {
     color: #ff3b30;
     font-size: 0.85rem;
     margin-top: -10px;
     margin-bottom: 10px;
   }
   
   .form-section-title {
     color: #1d1d1f;
     font-weight: 600;
     margin-bottom: 15px;
     margin-top: 20px;
     font-size: 1.1rem;
   }
   
   .form-section-title:first-child {
     margin-top: 0;
   }
   
   .form-row {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 15px;
   }
   
   /* Buttons */
   .primary-button {
     background: #007AFF;
     color: #fff;
     border: none;
     padding: 15px 25px;
     border-radius: 25px;
     font-weight: 600;
     cursor: pointer;
     margin-top: 20px;
     width: 100%;
     font-size: 1rem;
     transition: all 0.2s ease;
   }
   
   .primary-button:hover {
     background: #0056d6;
     transform: translateY(-1px);
     box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
   }
   
   .primary-button:disabled {
     opacity: 0.6;
     cursor: not-allowed;
     transform: none;
   }
   
   .secondary-button {
     background: #34c759;
     color: #fff;
     border: none;
     padding: 12px 20px;
     border-radius: 20px;
     font-weight: 500;
     cursor: pointer;
     margin-top: 15px;
     width: 100%;
     font-size: 0.95rem;
     transition: all 0.2s ease;
   }
   
   .secondary-button:hover {
     background: #30a752;
     transform: translateY(-1px);
   }
   
   .restart-button {
     position: fixed;
     top: 20px;
     right: 20px;
     background: #fff;
     border: 2px solid #e5e5e7;
     color: #1d1d1f;
     padding: 8px 16px;
     border-radius: 20px;
     cursor: pointer;
     font-size: 0.85rem;
     transition: all 0.2s ease;
     z-index: 1000;
     font-weight: 500;
   }
   
   .restart-button:hover {
     border-color: #007AFF;
     background: #f0f8ff;
   }
   
   .error-message {
     background: #ffebee;
     border: 2px solid #ffcdd2;
     color: #d32f2f;
     padding: 15px 18px;
     border-radius: 12px;
     margin-top: 15px;
     font-size: 0.95rem;
   }
   
   .success-message {
     background: #e8f5e8;
     border: 2px solid #c8e6c9;
     color: #2e7d32;
     padding: 15px 18px;
     border-radius: 12px;
     margin-top: 15px;
     font-size: 0.95rem;
   }
   
   .loading {
     opacity: 0.6;
     pointer-events: none;
   }
   
   /* Injector Availability Styles */
   .location-legend {
     background: #f9f9f9;
     border-radius: 8px;
     padding: 15px;
     margin: 15px 0;
   }
   
   .legend-title {
     font-weight: 600;
     margin-bottom: 10px;
     color: #1d1d1f;
     font-size: 0.95rem;
   }
   
   .legend-items {
     display: flex;
     flex-wrap: wrap;
     gap: 10px;
   }
   
   .legend-item {
     display: flex;
     align-items: center;
     gap: 8px;
     padding: 5px 10px;
     background: #fff;
     border-radius: 15px;
     border: 2px solid #e5e5e7;
     cursor: pointer;
     transition: all 0.2s ease;
     font-size: 0.85rem;
   }
   
   .legend-item:hover {
     border-color: #007AFF;
     transform: translateY(-1px);
   }
   
   .legend-item.inactive {
     opacity: 0.5;
     background: #f5f5f5;
   }
   
   .legend-color {
     width: 12px;
     height: 12px;
     border-radius: 3px;
     flex-shrink: 0;
   }
   
   .injector-calendar-day {
     position: relative;
   }
   
   .calendar-slots {
     display: flex;
     flex-direction: column;
     gap: 2px;
     margin-top: 4px;
   }
   
   .slot-indicator {
     height: 3px;
     border-radius: 1px;
     cursor: pointer;
     transition: all 0.2s ease;
   }
   
   .slot-indicator:hover {
     height: 5px;
     transform: translateY(-1px);
   }
   
   .injector-time-slots {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
     gap: 8px;
     max-height: 250px;
     overflow-y: auto;
     padding: 10px;
     background: #f9f9f9;
     border-radius: 8px;
     margin-top: 15px;
   }
   
   .injector-time-slot {
     background: #fff;
     border: 2px solid #e5e5e7;
     border-radius: 8px;
     padding: 10px;
     text-align: center;
     cursor: pointer;
     transition: all 0.2s ease;
     position: relative;
   }
   
   .injector-time-slot:hover {
     border-color: #007AFF;
     transform: translateY(-1px);
     box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
   }
   
   .slot-time {
     font-weight: 600;
     font-size: 0.9rem;
     margin-bottom: 4px;
   }
   
   .slot-location {
     font-size: 0.75rem;
     color: #86868b;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 6px;
   }
   
   .slot-location-color {
     width: 8px;
     height: 8px;
     border-radius: 2px;
     flex-shrink: 0;
   }
   
   /* Mobile Responsiveness */
   @media (max-width: 768px) {
     body {
       padding: 0;
       align-items: stretch;
     }
     
     .booking-widget {
       max-width: 100%;
       border-radius: 0;
       height: 100vh;
     }
     
     .messages-container {
       padding: 15px 20px;
     }
     
     .chat-header {
       padding: 15px 20px;
     }
     
     .treatment-grid {
       grid-template-columns: 1fr;
     }
     
     .form-row {
       grid-template-columns: 1fr;
     }
     
     .message-bubble {
       max-width: 85%;
     }
     
     .calendar-grid {
       grid-template-columns: repeat(7, 1fr);
       gap: 4px;
     }
     
     .calendar-day {
       min-height: 50px;
       padding: 4px 2px;
       font-size: 0.8rem;
     }
     
     .injector-list {
       gap: 8px;
       max-height: 250px;
     }
     
     .injector-item {
       padding: 6px 12px;
       min-height: 45px;
       gap: 10px;
     }
     
     .injector-photo {
       width: 30px;
       height: 30px;
     }
     
     .injector-name {
       font-size: 0.9rem;
     }
     
     .legend-items {
       flex-direction: column;
       gap: 8px;
     }
     
     .injector-time-slots {
       grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
       gap: 6px;
     }
   }
 </style>
</head>
<body>
 <div class="booking-widget">
   <div class="chat-header">
     <div class="chat-title">Get Plump Booking</div>
     <div class="chat-subtitle">Book your appointment</div>
   </div>
   
   <div class="restart-button" onclick="restartChat()">Start Over</div>
   
   <div class="messages-container" id="messages"></div>
 </div>

 <script>
   // Debug logging
   console.log('Widget loading...');
   
   // Boulevard API Configuration - using proxy route
   const BOULEVARD_CONFIG = {
     businessId: 'f6a06736-1132-4365-b79a-a69c648a746a',
     apiKey: '93ca3f15-6f0e-491d-840b-681a0fef80ed',
     apiUrl: '/api/blvd'
   };
   
   const LOCATIONS_DATA = {
     'West Village': { 
       locationId: 'ffaaff3c-d5ba-408e-ba3b-455554b77116'
     },
     'SoHo': { 
       locationId: '89763e68-2454-429c-ae9c-c1b4d91e7b81'
     },
     'Tribeca': { 
       locationId: '43dfb866-a872-4f01-9491-6c6584e3c3e7'
     },
     'Williamsburg': { 
       locationId: '93566b17-c023-4fe1-9a84-462f143bd024'
     },
     'Hoboken': { 
       locationId: 'a885e859-21ef-43c7-8a63-bb242db98de2'
     },
     'Uptown': { 
       locationId: 'b146c47b-6de8-475a-8ebd-8a1d2b36546d'
     },
     'Miami': { 
       locationId: '1cbb848e-138b-4142-bc3d-b9f4ea9a42db'
     }
   };
   
   // Custom service mapping for Injectable Treatments
   const INJECTABLE_SERVICES = [
     {
       id: 'botox',
       displayName: 'Botox',
       description: 'Botox Cosmetic or Dysport, used to treat upper face lines, tighten the lower face, neck bands, traps, jaw, and other. (Price varies, check website for full price list).',
       blvdServices: ['Botox', 'Dysport'],
       price: 'Contact for pricing'
     },
     {
       id: 'lip-filler',
       displayName: 'Lip Filler',
       description: 'Select between the Juvederm and Restylane family of fillers, 0.25cc–1cc. Price varies $425–850.',
       blvdServices: ['Lip filler'],
       price: '$425–850'
     },
     {
       id: 'facial-filler',
       displayName: 'Facial Filler',
       description: 'Sculpt, contour, and rejuvenate the face using Juvederm and Restylane. $850/syringe.',
       blvdServices: ['Cheek filler'],
       price: '$850/syringe'
     },
     {
       id: 'sculptra',
       displayName: 'Sculptra',
       description: 'Sculptra for face. $850/vial.',
       blvdServices: ['Sculptra For Face'],
       price: '$850/vial'
     },
     {
       id: 'mini-bbl',
       displayName: 'Mini BBL',
       description: 'Injectable BBL using Sculptra for body. 8 and 16 vials – $4000 and $6000.',
       blvdServices: ['Sculptra For Body'],
       price: '$4000–6000'
     },
     {
       id: 'other',
       displayName: 'Other',
       description: 'Looking for something else? Our team can help you find the right treatment.',
       blvdServices: [],
       price: 'Contact us'
     }
   ];
   
   // Global state
   let conversationState = 'start';
   let treatmentType = null;
   let bookingFlow = null;
   let selectedLocation = null;
   let selectedLocationId = null;
   let selectedInjector = null;
   let selectedInjectorId = null;
   let selectedService = null;
   let selectedServiceId = null;
   let selectedCustomService = null;
   let selectedTime = null;
   let cartId = null;
   let availableStaff = [];
   let availableServices = [];
   let availableTimes = [];
   let clientInfo = {};
   let currentCalendarDate = new Date();
   let calendarAvailability = {};
   let selectedDate = null;
   let injectorLocations = [];
   let locationColors = {};
   let visibleLocations = new Set();
   let injectorAvailabilityData = {};
   let userMembership = null;
   
   console.log('State initialized');
   
   // Utility functions
   function validateEmail(email) {
     const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
     return emailRegex.test(email);
   }
   
   function validatePhoneNumber(phone) {
     const digitsOnly = phone.replace(/\D/g, '');
     return digitsOnly.length >= 10 && digitsOnly.length <= 15;
   }
   
   // Boulevard API helper
   function makeBoulevardRequest(query, variables = {}) {
     console.log('🔥 Making Boulevard request:', { query: query.substring(0, 100) + '...', variables });
     
     return fetch(BOULEVARD_CONFIG.apiUrl, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'Accept': 'application/json'
       },
       body: JSON.stringify({
         query: query,
         variables: variables
       })
     })
     .then(response => {
       console.log('🔥 Boulevard response status:', response.status);
       if (!response.ok) {
         throw new Error(`HTTP ${response.status}: ${response.statusText}`);
       }
       return response.json();
     })
     .then(data => {
       console.log('🔥 Boulevard response data:', data);
       if (data.errors && data.errors.length > 0) {
         console.error('🔥 Boulevard GraphQL errors:', data.errors);
         throw new Error(`GraphQL Error: ${data.errors[0].message}`);
       }
       return data.data;
     })
     .catch(error => {
       console.error('🔥 Boulevard request failed:', error);
       throw error;
     });
   }
   
   // Membership functions
   function checkMembership(email, phone) {
     // Mock membership check - replace with actual API call
     const mockMembers = {
       'member@example.com': {
         isMember: true,
         credits: 150,
         nextBotoxEligible: '2024-03-15'
       }
     };
     
     return mockMembers[email] || { isMember: false };
   }
   
   function showMembershipTile() {
     if (userMembership && userMembership.isMember) {
       return; // Don't show if already a member
     }
     
     const container = document.getElementById('messages');
     const membershipMessage = document.createElement('div');
     membershipMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const membershipTile = document.createElement('div');
     membershipTile.className = 'membership-tile';
     membershipTile.onclick = () => openSMS('membership');
     
     const title = document.createElement('div');
     title.className = 'membership-title';
     title.textContent = 'Become a Member & Save';
     
     const desc = document.createElement('div');
     desc.className = 'membership-desc';
     desc.textContent = 'Join our membership for exclusive pricing and benefits';
     
     membershipTile.appendChild(title);
     membershipTile.appendChild(desc);
     bubble.appendChild(membershipTile);
     
     membershipMessage.appendChild(bubble);
     container.appendChild(membershipMessage);
     scrollToBottom();
   }
   
   function showMemberStatus() {
     if (!userMembership || !userMembership.isMember) {
       return;
     }
     
     const container = document.getElementById('messages');
     const statusMessage = document.createElement('div');
     statusMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const memberStatus = document.createElement('div');
     memberStatus.className = 'member-status';
     
     const credits = document.createElement('div');
     credits.className = 'member-credits';
     credits.textContent = `Member Credits: $${userMembership.credits}`;
     
     const eligibility = document.createElement('div');
     eligibility.className = 'member-eligibility';
     eligibility.textContent = `Next Botox eligible: ${userMembership.nextBotoxEligible}`;
     
     memberStatus.appendChild(credits);
     memberStatus.appendChild(eligibility);
     bubble.appendChild(memberStatus);
     
     statusMessage.appendChild(bubble);
     container.appendChild(statusMessage);
     scrollToBottom();
   }
   
   // Initialize
   document.addEventListener('DOMContentLoaded', function() {
     console.log('DOM loaded, starting conversation');
     startConversation();
   });
   
   function startConversation() {
     console.log('Starting conversation');
     const container = document.getElementById('messages');
     container.innerHTML = '';
     conversationState = 'start';
     
     // Reset all state
     treatmentType = null;
     bookingFlow = null;
     selectedLocation = null;
     selectedLocationId = null;
     selectedInjector = null;
     selectedInjectorId = null;
     selectedService = null;
     selectedServiceId = null;
     selectedCustomService = null;
     selectedTime = null;
     cartId = null;
     availableStaff = [];
     availableServices = [];
     availableTimes = [];
     clientInfo = {};
     currentCalendarDate = new Date();
     calendarAvailability = {};
     selectedDate = null;
     injectorLocations = [];
     locationColors = {};
     visibleLocations = new Set();
     injectorAvailabilityData = {};
     userMembership = null;
     
     addMessage('system', "Hi! Welcome to Get Plump. I'll help you book your appointment.", function() {
       addMessage('system', "What type of treatment are you interested in?", function() {
         showTreatmentTypeSelection();
       });
     });
   }
   
   function addMessage(type, text, callback) {
     const container = document.getElementById('messages');
     
     if (type === 'system') {
       showTyping(function() {
         const message = document.createElement('div');
         message.className = 'message ' + type;
         
         const bubble = document.createElement('div');
         bubble.className = 'message-bubble';
         bubble.innerHTML = text;
         
         message.appendChild(bubble);
         container.appendChild(message);
         scrollToBottom();
         
         if (callback) {
           setTimeout(callback, 500);
         }
       });
     } else {
       const message = document.createElement('div');
       message.className = 'message ' + type;
       
       const bubble = document.createElement('div');
       bubble.className = 'message-bubble';
       bubble.textContent = text;
       
       message.appendChild(bubble);
       container.appendChild(message);
       scrollToBottom();
       
       if (callback) {
         setTimeout(callback, 300);
       }
     }
   }
   
   function showTyping(callback) {
     const container = document.getElementById('messages');
     const typingMessage = document.createElement('div');
     typingMessage.className = 'message system';
     typingMessage.id = 'typing-indicator';
     
     const typingIndicator = document.createElement('div');
     typingIndicator.className = 'typing-indicator';
     
     const typingDots = document.createElement('div');
     typingDots.className = 'typing-dots';
     
     for (let i = 0; i < 3; i++) {
       const dot = document.createElement('div');
       dot.className = 'dot';
       typingDots.appendChild(dot);
     }
     
     typingIndicator.appendChild(typingDots);
     typingMessage.appendChild(typingIndicator);
     container.appendChild(typingMessage);
     scrollToBottom();
     
     setTimeout(function() {
       const indicator = document.getElementById('typing-indicator');
       if (indicator) {
         indicator.remove();
       }
       callback();
     }, 1200);
   }
   
   function showTreatmentTypeSelection() {
     console.log('Showing treatment type selection');
     const container = document.getElementById('messages');
     const treatmentMessage = document.createElement('div');
     treatmentMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const grid = document.createElement('div');
     grid.className = 'treatment-grid';
     
     // Injectable button
     const injectableButton = document.createElement('button');
     injectableButton.className = 'treatment-button';
     injectableButton.onclick = () => selectTreatmentType('injectable');
     
     const injectableTitle = document.createElement('div');
     injectableTitle.className = 'treatment-title';
     injectableTitle.textContent = 'Injectable Treatments';
     
     const injectableDesc = document.createElement('div');
     injectableDesc.className = 'treatment-desc';
     injectableDesc.textContent = 'Botox, fillers, and other injectable services';
     
     injectableButton.appendChild(injectableTitle);
     injectableButton.appendChild(injectableDesc);
     
     // Skin treatments button
     const skinButton = document.createElement('button');
     skinButton.className = 'treatment-button';
     skinButton.onclick = () => selectTreatmentType('skin');
     
     const skinTitle = document.createElement('div');
     skinTitle.className = 'treatment-title';
     skinTitle.textContent = 'Skin Treatments';
     
     const skinDesc = document.createElement('div');
     skinDesc.className = 'treatment-desc';
     skinDesc.textContent = 'Laser, microneedling, and skincare services';
     
     skinButton.appendChild(skinTitle);
     skinButton.appendChild(skinDesc);
     
     // Injector availability button
     const injectorAvailButton = document.createElement('button');
     injectorAvailButton.className = 'treatment-button';
     injectorAvailButton.onclick = () => selectTreatmentType('injector-availability');
     
     const injectorAvailTitle = document.createElement('div');
     injectorAvailTitle.className = 'treatment-title';
     injectorAvailTitle.textContent = 'See a Specific Injector\'s Availability';
     
     const injectorAvailDesc = document.createElement('div');
     injectorAvailDesc.className = 'treatment-desc';
     injectorAvailDesc.textContent = 'View open slots for your preferred injector across all locations';
     
     injectorAvailButton.appendChild(injectorAvailTitle);
     injectorAvailButton.appendChild(injectorAvailDesc);
     
     grid.appendChild(injectableButton);
     grid.appendChild(skinButton);
     grid.appendChild(injectorAvailButton);
     
     bubble.appendChild(grid);
     treatmentMessage.appendChild(bubble);
     container.appendChild(treatmentMessage);
     scrollToBottom();
   }
   
   function selectTreatmentType(type) {
     treatmentType = type;
     
     if (type === 'injectable') {
       addMessage('user', 'Injectable Treatments');
       addMessage('system', 'Great! For injectable treatments, would you like to book with a specific injector or choose a location first?', function() {
         showInjectableBookingFlow();
       });
     } else if (type === 'skin') {
       addMessage('user', 'Skin Treatments');
       addMessage('system', 'Perfect! Please select your preferred location:', function() {
         showLocationSelection();
       });
     } else if (type === 'injector-availability') {
       addMessage('user', 'See a Specific Injector\'s Availability');
       addMessage('system', 'Perfect! Let me load our team of injectors and their availability...', function() {
         loadInjectorsForAvailability();
       });
     }
   }
   
   function showInjectableBookingFlow() {
     const container = document.getElementById('messages');
     const flowMessage = document.createElement('div');
     flowMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const grid = document.createElement('div');
     grid.className = 'treatment-grid';
     grid.style.gridTemplateColumns = '1fr 1fr';
     
     // Book by injector
     const injectorButton = document.createElement('button');
     injectorButton.className = 'treatment-button';
     injectorButton.onclick = () => selectBookingFlow('by-injector');
     
     const injectorTitle = document.createElement('div');
     injectorTitle.className = 'treatment-title';
     injectorTitle.textContent = 'Book by Injector';
     
     const injectorDesc = document.createElement('div');
     injectorDesc.className = 'treatment-desc';
     injectorDesc.textContent = 'Choose your preferred injector first';
     
     injectorButton.appendChild(injectorTitle);
     injectorButton.appendChild(injectorDesc);
     
     // Book by location
     const locationButton = document.createElement('button');
     locationButton.className = 'treatment-button';
     locationButton.onclick = () => selectBookingFlow('by-location');
     
     const locationTitle = document.createElement('div');
     locationTitle.className = 'treatment-title';
     locationTitle.textContent = 'Book by Location';
     
     const locationDesc = document.createElement('div');
     locationDesc.className = 'treatment-desc';
     locationDesc.textContent = 'Choose your preferred location first';
     
     locationButton.appendChild(locationTitle);
     locationButton.appendChild(locationDesc);
     
     grid.appendChild(injectorButton);
     grid.appendChild(locationButton);
     
     bubble.appendChild(grid);
     flowMessage.appendChild(bubble);
     container.appendChild(flowMessage);
     scrollToBottom();
   }
   
   function selectBookingFlow(flow) {
     bookingFlow = flow;
     addMessage('user', flow === 'by-injector' ? 'Book by Injector' : 'Book by Location');
     
     if (flow === 'by-injector') {
       addMessage('system', 'Let me show you our available injectors...', function() {
         loadInjectors();
       });
     } else {
       addMessage('system', 'Please select your preferred location:', function() {
         showLocationSelection();
       });
     }
   }
   
   function loadInjectors() {
     console.log('🔍 Loading injectors from Boulevard API...');
     
     addMessage('system', 'Loading our team of injectors...');
     
     const locationEntries = Object.entries(LOCATIONS_DATA);
     console.log('🔍 Checking locations:', locationEntries.map(([name, data]) => name));
     
     const allStaffPromises = locationEntries.map(([locationName, locationData]) => {
       const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
         locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
       
       const query = `
         mutation CreateTempCart($locationId: ID!) {
           createCart(input: { locationId: $locationId }) {
             cart {
               id
               availableCategories {
                 name
                 availableItems {
                   id
                   name
                   ... on CartAvailableBookableItem {
                     staffVariants {
                       id
                       staff {
                         id
                         firstName
                         lastName
                         nickname
                         avatar
                       }
                     }
                   }
                 }
               }
             }
           }
         }
       `;
       
       return makeBoulevardRequest(query, { locationId: locationId })
         .then(data => ({
           locationName: locationName,
           locationId: locationId,
           cart: data.createCart.cart
         }))
         .catch(error => {
           console.error('🔍 Failed to load from location:', locationName, error);
           return { locationName: locationName, locationId: locationId, cart: null };
         });
     });
     
     Promise.all(allStaffPromises)
       .then(responses => {
         const staffMap = new Map();
         
         responses.forEach(response => {
           if (!response.cart) return;
           
           const { locationName, cart } = response;
           
           if (cart.availableCategories) {
             cart.availableCategories.forEach(category => {
               if (category.availableItems) {
                 category.availableItems.forEach(item => {
                   if (item.staffVariants && item.staffVariants.length > 0) {
                     item.staffVariants.forEach(variant => {
                       if (variant.staff) {
                         if (!staffMap.has(variant.staff.id)) {
                           staffMap.set(variant.staff.id, {
                             id: variant.staff.id,
                             firstName: variant.staff.firstName,
                             lastName: variant.staff.lastName,
                             nickname: variant.staff.nickname,
                             avatar: variant.staff.avatar ? { url: variant.staff.avatar } : null,
                             role: { name: 'Provider' },
                             locations: [locationName]
                           });
                         } else {
                           const staff = staffMap.get(variant.staff.id);
                           if (!staff.locations.includes(locationName)) {
                             staff.locations.push(locationName);
                           }
                         }
                       }
                     });
                   }
                 });
               }
             });
           }
         });
         
         const staffList = Array.from(staffMap.values());
         
         if (staffList.length > 0) {
           availableStaff = staffList;
           showInjectors();
         } else {
           loadEnhancedMockStaff();
         }
       })
       .catch(error => {
         console.error('❌ Failed to load staff from all locations:', error);
         loadEnhancedMockStaff();
       });
   }
   
   function loadEnhancedMockStaff() {
     const mockStaff = [
       {
         id: 'staff1',
         firstName: 'Sarah',
         lastName: 'Johnson',
         role: { name: 'Senior Injector' },
         avatar: null,
         locations: ['West Village', 'SoHo']
       },
       {
         id: 'staff2',
         firstName: 'Michael',
         lastName: 'Chen',
         role: { name: 'Lead Aesthetician' },
         avatar: null,
         locations: ['Tribeca', 'Williamsburg']
       },
       {
         id: 'staff3',
         firstName: 'Emily',
         lastName: 'Rodriguez',
         role: { name: 'Injector' },
         avatar: null,
         locations: ['Hoboken', 'Uptown']
       }
     ];
     
     availableStaff = mockStaff;
     showInjectors();
   }
   
   function showInjectors() {
     // Remove loading message
     const messages = document.querySelectorAll('.message');
     const lastMessage = messages[messages.length - 1];
     if (lastMessage && lastMessage.textContent.includes('Loading our team')) {
       lastMessage.remove();
     }
     
     const container = document.getElementById('messages');
     const injectorsMessage = document.createElement('div');
     injectorsMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const injectorContainer = document.createElement('div');
     injectorContainer.className = 'injector-container';
     
     const injectorList = document.createElement('div');
     injectorList.className = 'injector-list';
     
     // First Available option
     const firstAvailableItem = document.createElement('div');
     firstAvailableItem.className = 'injector-item first-available';
     firstAvailableItem.onclick = () => selectInjector('first-available', 'First Available');
     
     const firstAvailablePhoto = document.createElement('div');
     firstAvailablePhoto.className = 'injector-photo';
     
     const firstAvailableName = document.createElement('div');
     firstAvailableName.className = 'injector-name';
     firstAvailableName.textContent = 'First Available';
     
     firstAvailableItem.appendChild(firstAvailablePhoto);
     firstAvailableItem.appendChild(firstAvailableName);
     
     injectorList.appendChild(firstAvailableItem);
     
     // Individual injectors
     availableStaff.forEach((staff, index) => {
       const item = document.createElement('div');
       item.className = 'injector-item';
       item.onclick = () => selectInjector(staff.id, staff.firstName + ' ' + staff.lastName);
       
       const photo = document.createElement('div');
       photo.className = 'injector-photo';
       if (staff.avatar && staff.avatar.url) {
         photo.style.backgroundImage = `url(${staff.avatar.url})`;
       }
       
       const name = document.createElement('div');
       name.className = 'injector-name';
       name.textContent = staff.firstName + ' ' + staff.lastName;
       
       item.appendChild(photo);
       item.appendChild(name);
       
       injectorList.appendChild(item);
     });
     
     injectorContainer.appendChild(injectorList);
     bubble.appendChild(injectorContainer);
     
     const smsButton = document.createElement('button');
     smsButton.className = 'secondary-button';
     smsButton.textContent = "Don't see your preferred injector? Contact us";
     smsButton.onclick = () => openSMS('injector-inquiry');
     bubble.appendChild(smsButton);
     
     injectorsMessage.appendChild(bubble);
     container.appendChild(injectorsMessage);
     scrollToBottom();
   }
   
   function selectInjector(injectorId, injectorName) {
     selectedInjector = injectorName;
     selectedInjectorId = injectorId;
     addMessage('user', injectorName);
     
     addMessage('system', 'Perfect! Now please select your preferred location:', function() {
       showLocationSelection();
     });
   }
   
   function showLocationSelection() {
     const container = document.getElementById('messages');
     const locationMessage = document.createElement('div');
     locationMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const grid = document.createElement('div');
     grid.className = 'location-grid';
     
     let availableLocations = Object.keys(LOCATIONS_DATA);
     
     // If a specific injector is selected, only show their locations
     if (selectedInjectorId && selectedInjectorId !== 'first-available') {
       const selectedStaff = availableStaff.find(s => s.id === selectedInjectorId);
       if (selectedStaff && selectedStaff.locations) {
         availableLocations = selectedStaff.locations;
       }
     }
     
     availableLocations.forEach(locationName => {
       const button = document.createElement('button');
       button.className = 'location-button';
       button.textContent = locationName;
       button.onclick = () => selectLocation(locationName);
       grid.appendChild(button);
     });
     
     bubble.appendChild(grid);
     locationMessage.appendChild(bubble);
     container.appendChild(locationMessage);
     scrollToBottom();
   }
   
   function selectLocation(location) {
     selectedLocation = location;
     selectedLocationId = LOCATIONS_DATA[location].locationId;
     addMessage('user', location);
     
     if (treatmentType === 'injectable') {
       addMessage('system', `Perfect! Here are our injectable treatments available at ${location}:`, function() {
         showCustomInjectableServices();
       });
     } else {
       addMessage('system', `Perfect! Creating your booking session for ${location}...`);
       createCart();
     }
   }
   
   function showCustomInjectableServices() {
     const container = document.getElementById('messages');
     const serviceMessage = document.createElement('div');
     serviceMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const grid = document.createElement('div');
     grid.className = 'service-grid';
     
     INJECTABLE_SERVICES.forEach(service => {
       const button = document.createElement('button');
       button.className = 'service-button';
       button.onclick = () => selectCustomService(service);
       
       const serviceInfo = document.createElement('div');
       serviceInfo.className = 'service-info';
       
       const nameDiv = document.createElement('div');
       nameDiv.className = 'service-name';
       nameDiv.textContent = service.displayName;
       
       const descDiv = document.createElement('div');
       descDiv.className = 'service-description';
       descDiv.textContent = service.description;
       
       serviceInfo.appendChild(nameDiv);
       serviceInfo.appendChild(descDiv);
       
       const priceDiv = document.createElement('div');
       priceDiv.className = 'service-price';
       priceDiv.textContent = service.price;
       
       // Show member pricing if applicable
       if (userMembership && userMembership.isMember && service.memberPrice) {
         const memberPriceDiv = document.createElement('div');
         memberPriceDiv.className = 'member-price';
         memberPriceDiv.textContent = service.memberPrice;
         priceDiv.appendChild(memberPriceDiv);
       }
       
       button.appendChild(serviceInfo);
       button.appendChild(priceDiv);
       grid.appendChild(button);
     });
     
     bubble.appendChild(grid);
     serviceMessage.appendChild(bubble);
     container.appendChild(serviceMessage);
     scrollToBottom();
     
     // Show membership tile after services if not a member
     setTimeout(() => {
       showMembershipTile();
     }, 1000);
   }
   
   function selectCustomService(customService) {
     selectedCustomService = customService;
     addMessage('user', customService.displayName);
     
     if (customService.id === 'other') {
       addMessage('system', 'Perfect! Our team can help you find the right treatment. Let me connect you with them:', function() {
         showSMSOption();
       });
       return;
     }
     
     addMessage('system', `Great! I'll help you book ${customService.displayName}. Let me prepare your session...`);
     createCartForCustomService();
   }
   
   function createCartForCustomService() {
     const formattedLocationId = selectedLocationId.indexOf('urn:blvd:Location:') === 0 ? 
       selectedLocationId : 'urn:blvd:Location:' + selectedLocationId;
     
     const query = `
       mutation CreateCart($locationId: ID!) {
         createCart(input: { locationId: $locationId }) {
           cart {
             id
             expiresAt
             availableCategories {
               name
               availableItems {
                 id
                 name
                 description
                 ... on CartAvailableBookableItem {
                   listPrice
                   listDuration
                   staffVariants {
                     id
                     price
                     duration
                     staff {
                       id
                       firstName
                       lastName
                     }
                   }
                 }
               }
             }
           }
         }
       }
     `;
     
     makeBoulevardRequest(query, { locationId: formattedLocationId })
       .then(data => {
         const cart = data.createCart.cart;
         cartId = cart.id;
         
         // Find matching service in Boulevard
         const matchingService = findMatchingBoulevardService(cart, selectedCustomService);
         
         if (matchingService) {
           selectedService = selectedCustomService.displayName;
           selectedServiceId = matchingService.id;
           addServiceToCart();
         } else {
           addMessage('system', `I couldn't find ${selectedCustomService.displayName} at this location. Let me connect you with our team:`, function() {
             showSMSOption();
           });
         }
       })
       .catch(error => {
         console.error('Cart creation failed:', error.message);
         showErrorFallback('Unable to create booking session. Please try again or contact us.');
       });
   }
   
   function findMatchingBoulevardService(cart, customService) {
     const categories = cart.availableCategories || [];
     
     for (const category of categories) {
       const categoryItems = category.availableItems || [];
       
       for (const item of categoryItems) {
         // Check if this Boulevard service matches our custom service mapping
         for (const blvdServiceName of customService.blvdServices) {
           if (item.name.toLowerCase().includes(blvdServiceName.toLowerCase()) ||
               blvdServiceName.toLowerCase().includes(item.name.toLowerCase())) {
             
             // Filter staff variants if we have a specific injector selected
             let staffVariants = item.staffVariants || [];
             if (selectedInjectorId && selectedInjectorId !== 'first-available') {
               staffVariants = staffVariants.filter(variant => 
                 variant.staff && variant.staff.id === selectedInjectorId
               );
             }
             
             return {
               id: item.id,
               name: item.name,
               description: item.description,
               price: item.listPrice,
               duration: item.listDuration,
               staffVariants: staffVariants
             };
           }
         }
       }
     }
     
     return null;
   }
   
   function createCart() {
     const formattedLocationId = selectedLocationId.indexOf('urn:blvd:Location:') === 0 ? 
       selectedLocationId : 'urn:blvd:Location:' + selectedLocationId;
     
     const query = `
       mutation CreateCart($locationId: ID!) {
         createCart(input: { locationId: $locationId }) {
           cart {
             id
             expiresAt
             availableCategories {
               name
               availableItems {
                 id
                 name
                 description
                 ... on CartAvailableBookableItem {
                   listPrice
                   listDuration
                   staffVariants {
                     id
                     price
                     duration
                     staff {
                       id
                       firstName
                       lastName
                     }
                   }
                 }
               }
             }
           }
         }
       }
     `;
     
     makeBoulevardRequest(query, { locationId: formattedLocationId })
       .then(data => {
         const cart = data.createCart.cart;
         cartId = cart.id;
         
         loadServices(cart);
       })
       .catch(error => {
         console.error('Cart creation failed:', error.message);
         showErrorFallback('Unable to create booking session. Please try again or contact us.');
       });
   }
   
   function loadServices(cart) {
     const categories = cart.availableCategories || [];
     const services = [];
     
     for (const category of categories) {
       let categoryItems = category.availableItems || [];
       
       if (treatmentType === 'skin') {
         categoryItems = categoryItems.filter(item => 
           item.name.toLowerCase().includes('laser') ||
           item.name.toLowerCase().includes('microneedling') ||
           item.name.toLowerCase().includes('facial') ||
           item.name.toLowerCase().includes('peel') ||
           category.name.toLowerCase().includes('skin')
         );
       }
       for (const item of categoryItems) {
         // Get staff variants for this service
         let staffVariants = item.staffVariants || [];
         
         // If we have a specific injector selected, filter to only their variants
         if (selectedInjectorId && selectedInjectorId !== 'first-available') {
           staffVariants = staffVariants.filter(variant => 
             variant.staff && variant.staff.id === selectedInjectorId
           );
         }
         
         services.push({
           id: item.id,
           name: item.name,
           description: item.description,
           price: item.listPrice,
           duration: item.listDuration,
           category: category.name,
           staffVariants: staffVariants
         });
       }
     }
     
     if (services.length > 0) {
       availableServices = services;
       showServices();
     } else {
       showServiceFallback();
     }
   }
   
   function showServices() {
     const treatmentLabel = treatmentType === 'injectable' ? 'injectable treatments' : 'skin treatments';
     addMessage('system', `Here are the available ${treatmentLabel} at ${selectedLocation}:`, function() {
       const container = document.getElementById('messages');
       const serviceMessage = document.createElement('div');
       serviceMessage.className = 'message system';
       
       const bubble = document.createElement('div');
       bubble.className = 'message-bubble';
       
       const grid = document.createElement('div');
       grid.className = 'service-grid';
       
       for (const service of availableServices.slice(0, 10)) {
         const button = document.createElement('button');
         button.className = 'service-button';
         button.onclick = () => selectService(service.id, service.name);
         
         const serviceInfo = document.createElement('div');
         serviceInfo.className = 'service-info';
         
         const nameDiv = document.createElement('div');
         nameDiv.className = 'service-name';
         nameDiv.textContent = service.name;
         
         const durationDiv = document.createElement('div');
         durationDiv.className = 'service-duration';
         durationDiv.textContent = service.duration ? `${service.duration} minutes` : '';
         
         serviceInfo.appendChild(nameDiv);
         serviceInfo.appendChild(durationDiv);
         
         const priceDiv = document.createElement('div');
         priceDiv.className = 'service-price';
         priceDiv.textContent = service.price ? `$${Math.round(service.price / 100)}` : 'Contact for pricing';
         
         button.appendChild(serviceInfo);
         button.appendChild(priceDiv);
         grid.appendChild(button);
       }
       
       bubble.appendChild(grid);
       
       const smsButton = document.createElement('button');
       smsButton.className = 'secondary-button';
       smsButton.textContent = "Don't see what you're looking for? Contact us";
       smsButton.onclick = () => openSMS('service-inquiry');
       bubble.appendChild(smsButton);
       
       serviceMessage.appendChild(bubble);
       container.appendChild(serviceMessage);
       scrollToBottom();
       
       // Show membership tile after services if not a member
       setTimeout(() => {
         showMembershipTile();
       }, 1000);
     });
   }
   
   function selectService(serviceId, serviceName) {
     selectedService = serviceName;
     selectedServiceId = serviceId;
     addMessage('user', serviceName);
     
     addMessage('system', `Great! I've added ${serviceName} to your booking. Now let me find available appointment times...`);
     addServiceToCart();
   }
   
   function addServiceToCart() {
     const mutation = `
       mutation AddCartItem($cartId: ID!, $itemId: ID!, $itemStaffVariantId: ID) {
         addCartSelectedBookableItem(input: {
           id: $cartId,
           itemId: $itemId,
           itemStaffVariantId: $itemStaffVariantId
         }) {
           cart {
             id
             selectedItems {
               id
             }
           }
         }
       }
     `;
     
     const variables = { 
       cartId: cartId, 
       itemId: selectedServiceId 
     };
     
     // Add staff variant if we have a specific injector selected
     if (selectedInjectorId && selectedInjectorId !== 'first-available') {
       const selectedServiceData = availableServices.find(s => s.id === selectedServiceId);
       
       if (selectedServiceData && selectedServiceData.staffVariants) {
         const staffVariant = selectedServiceData.staffVariants.find(v => 
           v.staff && v.staff.id === selectedInjectorId
         );
         
         if (staffVariant) {
           variables.itemStaffVariantId = staffVariant.id;
         }
       }
     }
     
     makeBoulevardRequest(mutation, variables)
       .then(data => {
         console.log('Service added to cart');
         loadCalendarAvailability();
       })
       .catch(error => {
         console.error('Failed to add service:', error.message);
         showErrorFallback('Unable to add service. Please try again or contact us.');
       });
   }
   
   function loadCalendarAvailability() {
     addMessage('system', 'Here are the available appointment times:', function() {
       showCalendarView();
       loadAvailabilityForMonth();
     });
   }
   
   function showCalendarView() {
     const container = document.getElementById('messages');
     const calendarMessage = document.createElement('div');
     calendarMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const availabilityContainer = document.createElement('div');
     availabilityContainer.className = 'availability-container';
     availabilityContainer.id = 'availability-container';
     
     bubble.appendChild(availabilityContainer);
     
     const smsButton = document.createElement('button');
     smsButton.className = 'secondary-button';
     smsButton.textContent = "Don't see a good time? Contact us";
     smsButton.onclick = () => openSMS('time-inquiry');
     bubble.appendChild(smsButton);
     
     calendarMessage.appendChild(bubble);
     container.appendChild(calendarMessage);
     scrollToBottom();
   }
   
   function renderCalendar() {
     const container = document.getElementById('availability-container');
     container.innerHTML = '';
     
     // Calendar header with navigation
     const calendarHeader = document.createElement('div');
     calendarHeader.className = 'calendar-header';
     
     const prevButton = document.createElement('button');
     prevButton.className = 'calendar-nav';
     prevButton.textContent = '← Previous';
     prevButton.onclick = () => navigateMonth(-1);
     
     const calendarTitle = document.createElement('div');
     calendarTitle.className = 'calendar-title';
     calendarTitle.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
     
     const nextButton = document.createElement('button');
     nextButton.className = 'calendar-nav';
     nextButton.textContent = 'Next →';
     nextButton.onclick = () => navigateMonth(1);
     
     calendarHeader.appendChild(prevButton);
     calendarHeader.appendChild(calendarTitle);
     calendarHeader.appendChild(nextButton);
     
     // Calendar grid
     const calendarGrid = document.createElement('div');
     calendarGrid.className = 'calendar-grid';
     
     // Day headers
     const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
     dayHeaders.forEach(day => {
       const dayHeader = document.createElement('div');
       dayHeader.className = 'calendar-day-header';
       dayHeader.textContent = day;
       calendarGrid.appendChild(dayHeader);
     });
     
     // Generate calendar days
     const year = currentCalendarDate.getFullYear();
     const month = currentCalendarDate.getMonth();
     const firstDay = new Date(year, month, 1);
     const lastDay = new Date(year, month + 1, 0);
     const today = new Date();
     
     // Add empty cells for days before the first day of the month
     for (let i = 0; i < firstDay.getDay(); i++) {
       const emptyDay = document.createElement('div');
       emptyDay.className = 'calendar-day disabled';
       calendarGrid.appendChild(emptyDay);
     }
     
     // Add days of the month
     for (let day = 1; day <= lastDay.getDate(); day++) {
       const date = new Date(year, month, day);
       const dateStr = date.toISOString().split('T')[0];
       const dayElement = document.createElement('div');
       dayElement.className = 'calendar-day';
       
       // Check if day is in the past
       if (date < today) {
         dayElement.classList.add('disabled');
       } else {
         dayElement.onclick = () => selectCalendarDate(date);
         
         // Check if this day has availability
         if (calendarAvailability[dateStr] && calendarAvailability[dateStr].length > 0) {
           dayElement.classList.add('has-availability');
         }
       }
       
       const dayNumber = document.createElement('div');
       dayNumber.className = 'day-number';
       dayNumber.textContent = day;
       
       const dayAvailability = document.createElement('div');
       dayAvailability.className = 'day-availability';
       if (calendarAvailability[dateStr] && calendarAvailability[dateStr].length > 0) {
         dayAvailability.textContent = `${calendarAvailability[dateStr].length} slots`;
       }
       
       dayElement.appendChild(dayNumber);
       dayElement.appendChild(dayAvailability);
       calendarGrid.appendChild(dayElement);
     }
     
     container.appendChild(calendarHeader);
     container.appendChild(calendarGrid);
     
     // Time slots container (initially hidden)
     const timeSlotsContainer = document.createElement('div');
     timeSlotsContainer.className = 'time-slots';
     timeSlotsContainer.id = 'time-slots-container';
     timeSlotsContainer.style.display = 'none';
     container.appendChild(timeSlotsContainer);
   }
   
   function navigateMonth(direction) {
     currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
     renderCalendar();
     loadAvailabilityForMonth();
   }
   
   function loadAvailabilityForMonth() {
     const year = currentCalendarDate.getFullYear();
     const month = currentCalendarDate.getMonth();
     const firstDay = new Date(year, month, 1);
     const lastDay = new Date(year, month + 1, 0);
     
     // Load availability for all days in the month
     const promises = [];
     for (let day = 1; day <= lastDay.getDate(); day++) {
       const date = new Date(year, month, day);
       if (date >= new Date()) {
         promises.push(loadAvailabilityForDate(date));
       }
     }
     
     Promise.all(promises).then(() => {
       renderCalendar();
     });
   }
   
   function loadAvailabilityForDate(date) {
     const dateStr = date.toISOString().split('T')[0];
     
     const query = `
       query GetCartBookableTimes($cartId: ID!, $searchDate: Date!) {
         cartBookableTimes(
           id: $cartId,
           searchDate: $searchDate,
           tz: "America/New_York"
         ) {
           id
           startTime
         }
       }
     `;
     
     return makeBoulevardRequest(query, { 
       cartId: cartId, 
       searchDate: dateStr 
     })
       .then(data => {
         const times = data.cartBookableTimes || [];
         calendarAvailability[dateStr] = times;
         return times;
       })
       .catch(error => {
         console.error('Failed to load availability for', dateStr, error);
         calendarAvailability[dateStr] = [];
         return [];
       });
   }
   
   function selectCalendarDate(date) {
     selectedDate = date;
     const dateStr = date.toISOString().split('T')[0];
     
     // Update selected state in calendar
     document.querySelectorAll('.calendar-day').forEach(day => {
       day.classList.remove('selected');
     });
     
     // Find and select the clicked day
     const dayElements = document.querySelectorAll('.calendar-day');
     dayElements.forEach(dayElement => {
       const dayNumber = dayElement.querySelector('.day-number');
       if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
         dayElement.classList.add('selected');
       }
     });
     
     showTimeSlotsForDate(date);
   }
   
   function showTimeSlotsForDate(date) {
     const dateStr = date.toISOString().split('T')[0];
     const times = calendarAvailability[dateStr] || [];
     
     const timeSlotsContainer = document.getElementById('time-slots-container');
     timeSlotsContainer.innerHTML = '';
     
     if (times.length === 0) {
       timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No available times for this date</p>';
     } else {
       times.forEach(time => {
         const startTime = new Date(time.startTime);
         const timeStr = startTime.toLocaleTimeString('en-US', {
           hour: 'numeric',
           minute: '2-digit',
           hour12: true
         });
         
         const timeSlot = document.createElement('div');
         timeSlot.className = 'time-slot';
         timeSlot.textContent = timeStr;
         timeSlot.onclick = () => selectTime(time.id, timeStr, date.toLocaleDateString('en-US', {
           weekday: 'short',
           month: 'short',
           day: 'numeric'
         }), time.startTime);
         
         timeSlotsContainer.appendChild(timeSlot);
       });
     }
     
     timeSlotsContainer.style.display = 'block';
     scrollToBottom();
   }
   
   function selectTime(timeId, timeStr, dateStr, startTime) {
     selectedTime = { id: timeId, time: timeStr, date: dateStr, startTime: startTime };
     addMessage('user', `${dateStr} at ${timeStr}`);
     
     addMessage('system', `Perfect! I've noted your preferred time: ${dateStr} at ${timeStr}. Let me reserve this time slot...`);
     
     reserveTimeSlot();
   }
   
   function reserveTimeSlot() {
     const mutation = `
       mutation ReserveCartBookableItems($cartId: ID!, $bookableTimeId: ID!) {
         reserveCartBookableItems(input: {
           id: $cartId,
           bookableTimeId: $bookableTimeId
         }) {
           cart {
             id
           }
         }
       }
     `;
     
     makeBoulevardRequest(mutation, {
       cartId: cartId,
       bookableTimeId: selectedTime.id
     })
       .then(data => {
         console.log('✅ Time slot reserved successfully');
         addMessage('system', `Great! I've reserved your time slot. Now I need your contact information to complete your booking...`);
         showClientInfoForm();
       })
       .catch(error => {
         console.error('❌ Failed to reserve time slot:', error);
         addMessage('system', `I'm sorry, that time slot is no longer available. Please choose a different time.`);
         showErrorMessage('Time slot is no longer available. Please select a different time.');
       });
   }
   
   function showClientInfoForm() {
     setTimeout(function() {
       const container = document.getElementById('messages');
       const formMessage = document.createElement('div');
       formMessage.className = 'message system';
       
       const bubble = document.createElement('div');
       bubble.className = 'message-bubble';
       
       const formContainer = document.createElement('div');
       formContainer.className = 'form-container';
       
       const contactTitle = document.createElement('div');
       contactTitle.className = 'form-section-title';
       contactTitle.textContent = 'Contact Information';
       
       const nameRow = document.createElement('div');
       nameRow.className = 'form-row';
       
       const firstNameInput = document.createElement('input');
       firstNameInput.type = 'text';
       firstNameInput.className = 'form-input';
       firstNameInput.id = 'firstName';
       firstNameInput.placeholder = 'First Name';
       
       const lastNameInput = document.createElement('input');
       lastNameInput.type = 'text';
       lastNameInput.className = 'form-input';
       lastNameInput.id = 'lastName';
       lastNameInput.placeholder = 'Last Name';
       
       nameRow.appendChild(firstNameInput);
       nameRow.appendChild(lastNameInput);
       
       const emailInput = document.createElement('input');
       emailInput.type = 'email';
       emailInput.className = 'form-input';
       emailInput.id = 'email';
       emailInput.placeholder = 'Email Address';
       emailInput.oninput = () => {
         const email = emailInput.value.trim();
         if (validateEmail(email)) {
           const membership = checkMembership(email, '');
           if (membership.isMember !== (userMembership && userMembership.isMember)) {
             userMembership = membership;
             if (membership.isMember) {
               showMemberStatus();
             }
           }
         }
       };
       
       const phoneInput = document.createElement('input');
       phoneInput.type = 'tel';
       phoneInput.className = 'form-input';
       phoneInput.id = 'phone';
       phoneInput.placeholder = 'Phone Number';
       
       const submitButton = document.createElement('button');
       submitButton.className = 'primary-button';
       submitButton.textContent = 'Complete Booking';
       submitButton.onclick = completeBooking;
       
       formContainer.appendChild(contactTitle);
       formContainer.appendChild(nameRow);
       formContainer.appendChild(emailInput);
       formContainer.appendChild(phoneInput);
       formContainer.appendChild(submitButton);
       
       bubble.appendChild(formContainer);
       formMessage.appendChild(bubble);
       container.appendChild(formMessage);
       scrollToBottom();
       
       setTimeout(() => firstNameInput.focus(), 100);
     }, 1000);
   }
   
   function completeBooking() {
     const firstName = document.getElementById('firstName').value.trim();
     const lastName = document.getElementById('lastName').value.trim();
     const email = document.getElementById('email').value.trim();
     const phone = document.getElementById('phone').value.trim();
     
     // Clear previous errors
     document.querySelectorAll('.form-input').forEach(input => input.classList.remove('error'));
     document.querySelectorAll('.error-text').forEach(error => error.remove());
     
     let hasErrors = false;
     
     if (!firstName) {
       showFieldError('firstName', 'First name is required');
       hasErrors = true;
     }
     
     if (!lastName) {
       showFieldError('lastName', 'Last name is required');
       hasErrors = true;
     }
     
     if (!email) {
       showFieldError('email', 'Email is required');
       hasErrors = true;
     } else if (!validateEmail(email)) {
       showFieldError('email', 'Please enter a valid email address');
       hasErrors = true;
     }
     
     if (!phone) {
       showFieldError('phone', 'Phone number is required');
       hasErrors = true;
     } else if (!validatePhoneNumber(phone)) {
       showFieldError('phone', 'Please enter a valid phone number');
       hasErrors = true;
     }
     
     if (hasErrors) return;
     
     clientInfo = { firstName, lastName, email, phoneNumber: phone };
     
     const button = document.querySelector('.primary-button');
     const originalText = button.textContent;
     button.textContent = 'Processing...';
     button.disabled = true;
     
     addMessage('user', `${firstName} ${lastName} - ${email}`);
     
     // Mock booking completion - replace with actual Boulevard API calls
     setTimeout(() => {
       button.textContent = originalText;
       button.disabled = false;
       showBookingSuccess();
     }, 2000);
   }
   
   function showFieldError(fieldId, message) {
     const field = document.getElementById(fieldId);
     field.classList.add('error');
     
     const errorDiv = document.createElement('div');
     errorDiv.className = 'error-text';
     errorDiv.textContent = message;
     
     field.parentNode.insertBefore(errorDiv, field.nextSibling);
   }
   
   function showErrorMessage(message) {
     const container = document.getElementById('messages');
     const errorMessage = document.createElement('div');
     errorMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     bubble.innerHTML = `<div class="error-message">${message}</div>`;
     
     errorMessage.appendChild(bubble);
     container.appendChild(errorMessage);
     scrollToBottom();
   }
   
   function showBookingSuccess() {
     const injectorText = selectedInjector ? `Provider: ${selectedInjector}<br>` : '';
     const serviceText = selectedCustomService ? selectedCustomService.displayName : selectedService;
     
     const successMessage = `<div class="success-message"><strong>✅ Booking Completed Successfully!</strong><br><br>` +
                           `Location: ${selectedLocation}<br>` +
                           `Service: ${serviceText}<br>` +
                           `Date & Time: ${selectedTime.date} at ${selectedTime.time}<br>` +
                           `${injectorText}` +
                           `Client: ${clientInfo.firstName} ${clientInfo.lastName}<br><br>` +
                           `Your appointment has been confirmed and added to our calendar. You should receive a confirmation email shortly.</div>`;
     
     addMessage('system', successMessage, function() {
       showPostBookingOptions();
     });
   }
   
   function showPostBookingOptions() {
     const container = document.getElementById('messages');
     const optionsMessage = document.createElement('div');
     optionsMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const bookButton = document.createElement('button');
     bookButton.className = 'primary-button';
     bookButton.textContent = 'Book Another Appointment';
     bookButton.onclick = restartChat;
     
     const smsButton = document.createElement('button');
     smsButton.className = 'secondary-button';
     smsButton.textContent = 'Questions? Contact Us';
     smsButton.onclick = () => openSMS('follow-up');
     
     bubble.appendChild(bookButton);
     bubble.appendChild(smsButton);
     
     optionsMessage.appendChild(bubble);
     container.appendChild(optionsMessage);
     scrollToBottom();
   }
   
   // Injector Availability Functions
   function loadInjectorsForAvailability() {
     console.log('🔍 Loading injectors for availability view...');
     
     const container = document.getElementById('messages');
     const loadingMessage = document.createElement('div');
     loadingMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     bubble.textContent = 'Loading our team of injectors...';
     
     loadingMessage.appendChild(bubble);
     container.appendChild(loadingMessage);
     scrollToBottom();
     
     const locationEntries = Object.entries(LOCATIONS_DATA);
     
     const allStaffPromises = locationEntries.map(([locationName, locationData]) => {
       const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
         locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
       
       const query = `
         mutation CreateTempCart($locationId: ID!) {
           createCart(input: { locationId: $locationId }) {
             cart {
               id
               availableCategories {
                 name
                 availableItems {
                   id
                   name
                   ... on CartAvailableBookableItem {
                     staffVariants {
                       id
                       staff {
                         id
                         firstName
                         lastName
                         nickname
                         avatar
                       }
                     }
                   }
                 }
               }
             }
           }
         }
       `;
       
       return makeBoulevardRequest(query, { locationId: locationId })
         .then(data => ({
           locationName: locationName,
           locationId: locationId,
           cart: data.createCart.cart
         }))
         .catch(error => {
           console.error('🔍 Failed to load from location:', locationName, error);
           return { locationName: locationName, locationId: locationId, cart: null };
         });
     });
     
     Promise.all(allStaffPromises)
       .then(responses => {
         const staffMap = new Map();
         
         responses.forEach(response => {
           if (!response.cart) return;
           
           const { locationName, cart } = response;
           
           if (cart.availableCategories) {
             cart.availableCategories.forEach(category => {
               if (category.availableItems) {
                 category.availableItems.forEach(item => {
                   if (item.staffVariants && item.staffVariants.length > 0) {
                     item.staffVariants.forEach(variant => {
                       if (variant.staff) {
                         if (!staffMap.has(variant.staff.id)) {
                           staffMap.set(variant.staff.id, {
                             id: variant.staff.id,
                             firstName: variant.staff.firstName,
                             lastName: variant.staff.lastName,
                             nickname: variant.staff.nickname,
                             avatar: variant.staff.avatar ? { url: variant.staff.avatar } : null,
                             locations: [locationName]
                           });
                         } else {
                           const staff = staffMap.get(variant.staff.id);
                           if (!staff.locations.includes(locationName)) {
                             staff.locations.push(locationName);
                           }
                         }
                       }
                     });
                   }
                 });
               }
             });
           }
         });
         
         const staffList = Array.from(staffMap.values());
         
         if (staffList.length > 0) {
           availableStaff = staffList;
           assignLocationColors(staffList);
           showInjectorsForAvailability();
         } else {
           loadMockStaffForAvailability();
         }
       })
       .catch(error => {
         console.error('❌ Failed to load staff:', error);
         loadMockStaffForAvailability();
       });
   }
   
   function loadMockStaffForAvailability() {
     const mockStaff = [
       {
         id: 'staff1',
         firstName: 'Sarah',
         lastName: 'Johnson',
         avatar: null,
         locations: ['West Village', 'SoHo']
       },
       {
         id: 'staff2',
         firstName: 'Michael',
         lastName: 'Chen',
         avatar: null,
         locations: ['Tribeca', 'Williamsburg']
       },
       {
         id: 'staff3',
         firstName: 'Emily',
         lastName: 'Rodriguez',
         avatar: null,
         locations: ['Hoboken', 'Uptown']
       }
     ];
     
     availableStaff = mockStaff;
     assignLocationColors(mockStaff);
     showInjectorsForAvailability();
   }
   
   function assignLocationColors(staffList) {
     const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6', '#AF52DE', '#FF2D92'];
     const allLocations = new Set();
     
     staffList.forEach(staff => {
       staff.locations.forEach(location => allLocations.add(location));
     });
     
     const locationArray = Array.from(allLocations);
     locationColors = {};
     
     locationArray.forEach((location, index) => {
       locationColors[location] = colors[index % colors.length];
     });
   }
   
   function showInjectorsForAvailability() {
     // Remove loading message
     const messages = document.querySelectorAll('.message');
     const lastMessage = messages[messages.length - 1];
     if (lastMessage && lastMessage.textContent.includes('Loading our team')) {
       lastMessage.remove();
     }
     
     const container = document.getElementById('messages');
     const injectorsMessage = document.createElement('div');
     injectorsMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     bubble.innerHTML = 'Select an injector to view their availability across all locations:';
     
     const injectorContainer = document.createElement('div');
     injectorContainer.className = 'injector-container';
     
     const injectorList = document.createElement('div');
     injectorList.className = 'injector-list';
     
     availableStaff.forEach((staff, index) => {
       const item = document.createElement('div');
       item.className = 'injector-item';
       item.onclick = () => selectInjectorForAvailability(staff);
       
       const photo = document.createElement('div');
       photo.className = 'injector-photo';
       if (staff.avatar && staff.avatar.url) {
         photo.style.backgroundImage = `url(${staff.avatar.url})`;
       }
       
       const info = document.createElement('div');
       info.style.flex = '1';
       
       const name = document.createElement('div');
       name.className = 'injector-name';
       name.textContent = `${staff.firstName} ${staff.lastName}`;
       
       const locations = document.createElement('div');
       locations.style.fontSize = '0.8rem';
       locations.style.color = '#86868b';
       locations.style.marginTop = '4px';
       locations.textContent = staff.locations.join(', ');
       
       info.appendChild(name);
       info.appendChild(locations);
       
       item.appendChild(photo);
       item.appendChild(info);
       
       injectorList.appendChild(item);
     });
     
     injectorContainer.appendChild(injectorList);
     bubble.appendChild(injectorContainer);
     
     injectorsMessage.appendChild(bubble);
     container.appendChild(injectorsMessage);
     scrollToBottom();
   }
   
   function selectInjectorForAvailability(staff) {
     selectedInjector = `${staff.firstName} ${staff.lastName}`;
     selectedInjectorId = staff.id;
     injectorLocations = staff.locations;
     
     // Reset and initialize visibility
     visibleLocations = new Set(staff.locations);
     injectorAvailabilityData = {};
     
     addMessage('user', selectedInjector);
     addMessage('system', `Perfect! Loading ${selectedInjector}'s availability across all locations...`, function() {
       loadInjectorAvailabilityAcrossLocations();
     });
   }
   
   function loadInjectorAvailabilityAcrossLocations() {
     console.log('🔍 Loading availability for injector across all locations');
     
     const promises = injectorLocations.map(locationName => {
       return loadInjectorAvailabilityForLocation(locationName);
     });
     
     Promise.all(promises)
       .then(() => {
         console.log('✅ Loaded availability for all locations');
         showInjectorAvailabilityCalendar();
       })
       .catch(error => {
         console.error('❌ Failed to load availability:', error);
         showErrorMessage('Unable to load availability. Please try again or contact us.');
       });
   }
   
   function loadInjectorAvailabilityForLocation(locationName) {
     const locationData = LOCATIONS_DATA[locationName];
     if (!locationData) return Promise.resolve();
     
     const locationId = locationData.locationId.indexOf('urn:blvd:Location:') === 0 ? 
       locationData.locationId : 'urn:blvd:Location:' + locationData.locationId;
     
     // Mock availability data for demonstration
     const mockAvailability = {};
     const today = new Date();
     
     for (let i = 0; i < 30; i++) {
       const date = new Date(today);
       date.setDate(date.getDate() + i);
       const dateStr = date.toISOString().split('T')[0];
       
       // Generate random availability
       const numSlots = Math.floor(Math.random() * 5);
       const slots = [];
       
       for (let j = 0; j < numSlots; j++) {
         const hour = 9 + Math.floor(Math.random() * 8); // 9 AM to 5 PM
         const minute = Math.random() < 0.5 ? 0 : 30;
         const slotTime = new Date(date);
         slotTime.setHours(hour, minute, 0, 0);
         
         slots.push({
           id: `slot_${locationName}_${dateStr}_${j}`,
           startTime: slotTime.toISOString()
         });
       }
       
       mockAvailability[dateStr] = slots;
     }
     
     // Store availability data
     Object.keys(mockAvailability).forEach(dateStr => {
       if (!injectorAvailabilityData[dateStr]) {
         injectorAvailabilityData[dateStr] = {};
       }
       injectorAvailabilityData[dateStr][locationName] = mockAvailability[dateStr];
     });
     
     return Promise.resolve();
   }
   
   function showInjectorAvailabilityCalendar() {
     const container = document.getElementById('messages');
     const calendarMessage = document.createElement('div');
     calendarMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     // Location legend and toggle
     const legend = document.createElement('div');
     legend.className = 'location-legend';
     
     const legendTitle = document.createElement('div');
     legendTitle.className = 'legend-title';
     legendTitle.textContent = 'Locations (click to toggle):';
     
     const legendItems = document.createElement('div');
     legendItems.className = 'legend-items';
     
     injectorLocations.forEach(locationName => {
       const legendItem = document.createElement('div');
       legendItem.className = 'legend-item';
       legendItem.onclick = () => toggleLocationVisibility(locationName);
       
       const colorDiv = document.createElement('div');
       colorDiv.className = 'legend-color';
       colorDiv.style.backgroundColor = locationColors[locationName];
       
       const nameDiv = document.createElement('div');
       nameDiv.textContent = locationName;
       
       legendItem.appendChild(colorDiv);
       legendItem.appendChild(nameDiv);
       legendItems.appendChild(legendItem);
     });
     
     legend.appendChild(legendTitle);
     legend.appendChild(legendItems);
     
     // Calendar container
     const availabilityContainer = document.createElement('div');
     availabilityContainer.className = 'availability-container';
     availabilityContainer.id = 'injector-availability-container';
     
     bubble.appendChild(legend);
     bubble.appendChild(availabilityContainer);
     
     calendarMessage.appendChild(bubble);
     container.appendChild(calendarMessage);
     scrollToBottom();
     
     renderInjectorAvailabilityCalendar();
   }
   
   function toggleLocationVisibility(locationName) {
     if (visibleLocations.has(locationName)) {
       visibleLocations.delete(locationName);
     } else {
       visibleLocations.add(locationName);
     }
     
     // Update legend items
     const legendItems = document.querySelectorAll('.legend-item');
     legendItems.forEach(item => {
       const locationText = item.textContent;
       if (locationText === locationName) {
         if (visibleLocations.has(locationName)) {
           item.classList.remove('inactive');
         } else {
           item.classList.add('inactive');
         }
       }
     });
     
     renderInjectorAvailabilityCalendar();
   }
   
   function renderInjectorAvailabilityCalendar() {
     const container = document.getElementById('injector-availability-container');
     container.innerHTML = '';
     
     // Calendar header
     const calendarHeader = document.createElement('div');
     calendarHeader.className = 'calendar-header';
     
     const calendarTitle = document.createElement('div');
     calendarTitle.className = 'calendar-title';
     calendarTitle.textContent = `${selectedInjector}'s Availability`;
     
     calendarHeader.appendChild(calendarTitle);
     
     // Calendar grid
     const calendarGrid = document.createElement('div');
     calendarGrid.className = 'calendar-grid';
     
     // Day headers
     const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
     dayHeaders.forEach(day => {
       const dayHeader = document.createElement('div');
       dayHeader.className = 'calendar-day-header';
       dayHeader.textContent = day;
       calendarGrid.appendChild(dayHeader);
     });
     
     // Generate calendar for current month
     const today = new Date();
     const year = today.getFullYear();
     const month = today.getMonth();
     const firstDay = new Date(year, month, 1);
     const lastDay = new Date(year, month + 1, 0);
     
     // Add empty cells for days before the first day of the month
     for (let i = 0; i < firstDay.getDay(); i++) {
       const emptyDay = document.createElement('div');
       emptyDay.className = 'calendar-day disabled';
       calendarGrid.appendChild(emptyDay);
     }
     
     // Add days of the month
     for (let day = 1; day <= lastDay.getDate(); day++) {
       const date = new Date(year, month, day);
       const dateStr = date.toISOString().split('T')[0];
       const dayElement = document.createElement('div');
       dayElement.className = 'calendar-day injector-calendar-day';
       
       // Check if day is in the past
       if (date < today) {
         dayElement.classList.add('disabled');
       } else {
         dayElement.onclick = () => selectInjectorDate(date);
       }
       
       const dayNumber = document.createElement('div');
       dayNumber.className = 'day-number';
       dayNumber.textContent = day;
       
       const slotsContainer = document.createElement('div');
       slotsContainer.className = 'calendar-slots';
       
       // Add slot indicators for visible locations
       const dayData = injectorAvailabilityData[dateStr];
       if (dayData) {
         let hasSlots = false;
         
         Object.keys(dayData).forEach(locationName => {
           if (!visibleLocations.has(locationName)) return;
           
           const slots = dayData[locationName];
           if (slots && slots.length > 0) {
             hasSlots = true;
             
             const slotsToShow = Math.min(3, slots.length);
             for (let i = 0; i < slotsToShow; i++) {
               const slotIndicator = document.createElement('div');
               slotIndicator.className = 'slot-indicator';
               slotIndicator.style.backgroundColor = locationColors[locationName];
               slotsContainer.appendChild(slotIndicator);
             }
           }
         });
         
         if (hasSlots) {
           dayElement.classList.add('has-availability');
         }
       }
       
       dayElement.appendChild(dayNumber);
       dayElement.appendChild(slotsContainer);
       calendarGrid.appendChild(dayElement);
     }
     
     container.appendChild(calendarHeader);
     container.appendChild(calendarGrid);
     
     // Time slots container (initially hidden)
     const timeSlotsContainer = document.createElement('div');
     timeSlotsContainer.className = 'injector-time-slots';
     timeSlotsContainer.id = 'injector-time-slots-container';
     timeSlotsContainer.style.display = 'none';
     container.appendChild(timeSlotsContainer);
   }
   
   function selectInjectorDate(date) {
     selectedDate = date;
     const dateStr = date.toISOString().split('T')[0];
     
     // Update selected state in calendar
     document.querySelectorAll('.injector-calendar-day').forEach(day => {
       day.classList.remove('selected');
     });
     
     // Find and select the clicked day
     const dayElements = document.querySelectorAll('.injector-calendar-day');
     dayElements.forEach(dayElement => {
       const dayNumber = dayElement.querySelector('.day-number');
       if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
         dayElement.classList.add('selected');
       }
     });
     
     showInjectorTimeSlotsForDate(date);
   }
   
   function showInjectorTimeSlotsForDate(date) {
     const dateStr = date.toISOString().split('T')[0];
     const dayData = injectorAvailabilityData[dateStr];
     
     const timeSlotsContainer = document.getElementById('injector-time-slots-container');
     timeSlotsContainer.innerHTML = '';
     
     if (!dayData) {
       timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No availability data for this date</p>';
       timeSlotsContainer.style.display = 'block';
       return;
     }
     
     const allSlots = [];
     
     // Collect all slots from visible locations
     Object.keys(dayData).forEach(locationName => {
       if (!visibleLocations.has(locationName)) return;
       
       const slots = dayData[locationName] || [];
       slots.forEach(slot => {
         allSlots.push({
           ...slot,
           locationName: locationName,
           color: locationColors[locationName]
         });
       });
     });
     
     if (allSlots.length === 0) {
       timeSlotsContainer.innerHTML = '<p style="text-align: center; color: #86868b; padding: 20px;">No available times for this date</p>';
     } else {
       // Sort slots by time
       allSlots.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
       
       allSlots.forEach(slot => {
         const startTime = new Date(slot.startTime);
         const timeStr = startTime.toLocaleTimeString('en-US', {
           hour: 'numeric',
           minute: '2-digit',
           hour12: true
         });
         
         const timeSlot = document.createElement('div');
         timeSlot.className = 'injector-time-slot';
         timeSlot.onclick = () => selectInjectorTimeSlot(slot, timeStr, date.toLocaleDateString('en-US', {
           weekday: 'short',
           month: 'short',
           day: 'numeric'
         }));
         
         const timeDiv = document.createElement('div');
         timeDiv.className = 'slot-time';
         timeDiv.textContent = timeStr;
         
         const locationDiv = document.createElement('div');
         locationDiv.className = 'slot-location';
         
         const colorDiv = document.createElement('div');
         colorDiv.className = 'slot-location-color';
         colorDiv.style.backgroundColor = slot.color;
         
         const nameDiv = document.createElement('div');
         nameDiv.textContent = slot.locationName;
         
         locationDiv.appendChild(colorDiv);
         locationDiv.appendChild(nameDiv);
         
         timeSlot.appendChild(timeDiv);
         timeSlot.appendChild(locationDiv);
         
         timeSlotsContainer.appendChild(timeSlot);
       });
     }
     
     timeSlotsContainer.style.display = 'block';
     scrollToBottom();
   }
   
   function selectInjectorTimeSlot(slot, timeStr, dateStr) {
     selectedTime = { id: slot.id, time: timeStr, date: dateStr, startTime: slot.startTime };
     selectedLocation = slot.locationName;
     selectedLocationId = LOCATIONS_DATA[slot.locationName].locationId;
     
     addMessage('user', `${dateStr} at ${timeStr} - ${slot.locationName}`);
     addMessage('system', `Perfect! I've noted your appointment with ${selectedInjector} at ${slot.locationName} on ${dateStr} at ${timeStr}. Let me prepare your booking...`);
     
     // For injector availability flow, continue with client info form
     // In a real implementation, you'd create a proper cart and reserve the slot
     setTimeout(() => {
       addMessage('system', 'Great! Now I need your contact information to complete your booking...');
       showClientInfoForm();
     }, 1500);
   }
   
   function showServiceFallback() {
     addMessage('system', 'I\'m having trouble loading services right now. Let me connect you with our team:', function() {
       showSMSOption();
     });
   }
   
   function showErrorFallback(message) {
     addMessage('system', message + ' Let me connect you:', function() {
       showSMSOption();
     });
   }
   
   function showSMSOption() {
     const container = document.getElementById('messages');
     const smsMessage = document.createElement('div');
     smsMessage.className = 'message system';
     
     const bubble = document.createElement('div');
     bubble.className = 'message-bubble';
     
     const smsButton = document.createElement('button');
     smsButton.className = 'secondary-button';
     smsButton.textContent = 'Text us at (646) 346-8809';
     smsButton.onclick = () => openSMS('help');
     
     bubble.appendChild(smsButton);
     smsMessage.appendChild(bubble);
     
     container.appendChild(smsMessage);
     scrollToBottom();
   }
   
   function openSMS(context) {
     let message = "I'd like to book an appointment at Get Plump";
     
     if (context === 'follow-up') {
       message = "I just completed a booking and have a question";
     } else if (context === 'injector-inquiry') {
       message = 'I\'m looking for a specific injector that wasn\'t listed';
     } else if (context === 'service-inquiry') {
       message = `I'm looking for services at ${selectedLocation} but need different options`;
     } else if (context === 'membership') {
       message = 'I\'m interested in learning about membership options';
     }
     
     message += ".";
     
     const encodedMessage = encodeURIComponent(message);
     window.location.href = 'sms:+16463468809?body=' + encodedMessage;
   }
   
   function restartChat() {
     startConversation();
   }
   
   function scrollToBottom() {
     const container = document.getElementById('messages');
     setTimeout(() => {
       container.scrollTop = container.scrollHeight;
     }, 100);
   }
   
   console.log('✅ Script fully loaded with enhanced features');
 </script>
</body>
</html>
      
